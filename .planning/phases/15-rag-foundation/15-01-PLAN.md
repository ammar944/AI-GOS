---
phase: 15-rag-foundation
plan: 01
type: execute
---

<objective>
Set up pgvector extension and create database schema for RAG-powered Blueprint Chat.

Purpose: Establish the database foundation for storing blueprints, semantic chunks, and vector embeddings.
Output: Supabase migrations enabling vector search on blueprint content.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-rag-foundation/DISCOVERY.md
@.planning/docs/Blueprint_AI_Chat_RAG_Specification_OpenRouter.md

**Codebase constraints:**
- Use Supabase MCP tools for migrations (mcp__supabase__apply_migration)
- Project ID: sidrtuxpqftyzwdusdha
- PostgreSQL 17.6.1, pgvector 0.8.0 available

**Current state:**
- Only `shared_blueprints` table exists
- pgvector extension NOT enabled
- Blueprints currently stored in localStorage only
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable pgvector and create blueprints table</name>
  <files>Supabase migration (via MCP)</files>
  <action>
Apply migration to:
1. Enable pgvector extension: `CREATE EXTENSION IF NOT EXISTS vector;`
2. Create `blueprints` table with columns:
   - id: UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - user_id: UUID NOT NULL (references auth.users - add FK later when auth integrated)
   - title: TEXT NOT NULL
   - input_data: JSONB NOT NULL (the OnboardingData that generated this blueprint)
   - output: JSONB NOT NULL (the StrategicBlueprintOutput)
   - generation_metadata: JSONB (model versions, costs, timing)
   - created_at: TIMESTAMPTZ DEFAULT NOW()
   - updated_at: TIMESTAMPTZ DEFAULT NOW()
3. Add index on user_id for user's blueprints lookup
4. Enable RLS on blueprints table (policy: users can only access their own)

Use migration name: `enable_pgvector_create_blueprints`
  </action>
  <verify>
Run mcp__supabase__list_tables to confirm blueprints table exists.
Run mcp__supabase__list_extensions to confirm vector extension is installed.
  </verify>
  <done>pgvector extension enabled, blueprints table created with RLS</done>
</task>

<task type="auto">
  <name>Task 2: Create blueprint_chunks table with vector column</name>
  <files>Supabase migration (via MCP)</files>
  <action>
Apply migration to create `blueprint_chunks` table:
```sql
CREATE TABLE blueprint_chunks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  blueprint_id UUID NOT NULL REFERENCES blueprints(id) ON DELETE CASCADE,
  section TEXT NOT NULL,
  field_path TEXT NOT NULL,
  content TEXT NOT NULL,
  content_type TEXT NOT NULL,
  embedding vector(1536),  -- text-embedding-3-small dimensions
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT valid_section CHECK (section IN (
    'industryMarketOverview',
    'icpAnalysisValidation',
    'offerAnalysisViability',
    'competitorAnalysis',
    'crossAnalysisSynthesis'
  )),
  CONSTRAINT valid_content_type CHECK (content_type IN (
    'string', 'number', 'array', 'object', 'enum'
  ))
);

-- Vector similarity search index (IVFFlat for our scale)
CREATE INDEX idx_blueprint_chunks_embedding
ON blueprint_chunks
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- Index for filtering by blueprint
CREATE INDEX idx_blueprint_chunks_blueprint_id
ON blueprint_chunks(blueprint_id);

-- Index for filtering by section
CREATE INDEX idx_blueprint_chunks_section
ON blueprint_chunks(blueprint_id, section);

-- Enable RLS
ALTER TABLE blueprint_chunks ENABLE ROW LEVEL SECURITY;

-- RLS policy: users can access chunks of their own blueprints
CREATE POLICY "Users can access own blueprint chunks"
ON blueprint_chunks FOR ALL
USING (
  blueprint_id IN (
    SELECT id FROM blueprints WHERE user_id = auth.uid()
  )
);
```

Use migration name: `create_blueprint_chunks`
  </action>
  <verify>
Run mcp__supabase__list_tables to confirm blueprint_chunks table exists with correct columns.
Run mcp__supabase__execute_sql with `SELECT * FROM pg_indexes WHERE tablename = 'blueprint_chunks';` to verify indexes.
  </verify>
  <done>blueprint_chunks table created with vector column, indexes, and RLS policy</done>
</task>

<task type="auto">
  <name>Task 3: Create match_blueprint_chunks RPC function</name>
  <files>Supabase migration (via MCP)</files>
  <action>
Apply migration to create vector similarity search function:
```sql
-- Vector similarity search with optional section filter
CREATE OR REPLACE FUNCTION match_blueprint_chunks(
  query_embedding vector(1536),
  p_blueprint_id UUID,
  match_threshold FLOAT DEFAULT 0.7,
  match_count INT DEFAULT 5,
  section_filter TEXT DEFAULT NULL
)
RETURNS TABLE (
  id UUID,
  section TEXT,
  field_path TEXT,
  content TEXT,
  content_type TEXT,
  metadata JSONB,
  similarity FLOAT
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  RETURN QUERY
  SELECT
    bc.id,
    bc.section,
    bc.field_path,
    bc.content,
    bc.content_type,
    bc.metadata,
    1 - (bc.embedding <=> query_embedding) AS similarity
  FROM blueprint_chunks bc
  WHERE bc.blueprint_id = p_blueprint_id
    AND (section_filter IS NULL OR bc.section = section_filter)
    AND 1 - (bc.embedding <=> query_embedding) > match_threshold
  ORDER BY bc.embedding <=> query_embedding
  LIMIT match_count;
END;
$$;

-- Grant execute to authenticated users
GRANT EXECUTE ON FUNCTION match_blueprint_chunks TO authenticated;
```

Use migration name: `create_match_chunks_function`
  </action>
  <verify>
Run mcp__supabase__execute_sql with:
`SELECT routine_name FROM information_schema.routines WHERE routine_name = 'match_blueprint_chunks';`
to confirm function exists.
  </verify>
  <done>match_blueprint_chunks RPC function created and accessible to authenticated users</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pgvector extension shows as installed in list_extensions
- [ ] blueprints table exists with correct schema
- [ ] blueprint_chunks table exists with vector(1536) column
- [ ] IVFFlat index exists on embedding column
- [ ] match_blueprint_chunks function exists
- [ ] RLS policies are enabled on both tables
</verification>

<success_criteria>
- pgvector extension enabled
- blueprints table created with proper schema
- blueprint_chunks table created with 1536-dim vector column
- Vector similarity search RPC function working
- All migrations applied successfully
</success_criteria>

<output>
After completion, create `.planning/phases/15-rag-foundation/15-01-SUMMARY.md`
</output>
