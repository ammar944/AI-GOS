---
phase: 07-approval-flow
plan: 01
type: execute
---

<objective>
Implement approval flow that merges user edits into strategic blueprint and persists approved version for media plan generation.

Purpose: Complete the validation gate by allowing users to approve their reviewed/edited research before proceeding to media plan generation.
Output: Approved strategic blueprint saved to localStorage, ready to feed into media plan pipeline.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase summaries:**
@.planning/phases/06-inline-edit-capability/06-02-SUMMARY.md

**Codebase constraints:**
- React state management via useState (no external state library)
- localStorage for persistence via `src/lib/storage/local-storage.ts`
- Strategic blueprint type: `StrategicBlueprintOutput` from `src/lib/strategic-blueprint/output-types.ts`

**Relevant source files:**
@src/components/strategic-research/review.tsx
@src/app/generate/page.tsx
@src/lib/storage/local-storage.ts
@src/lib/strategic-blueprint/output-types.ts

**Prior decisions affecting this phase:**
- Phase 06-02: pendingEdits stored as `{ sectionKey: { fieldPath: newValue } }` map
- Phase 06-02: `setFieldAtPath` helper exists for deep-merging edits into objects
- Phase 05-02: Review component requires all 5 sections reviewed before Continue enabled

**Current state:**
- `pendingEdits` tracks all user edits in review.tsx
- `getMergedSectionData()` already merges edits for display
- `/api/media-plan/full-plan` accepts optional `strategicBlueprint` parameter
- localStorage has `setStrategicBlueprint()` for saving
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create createApprovedBlueprint helper function</name>
  <files>src/lib/strategic-blueprint/approval.ts</files>
  <action>
Create a new file with helper function to merge pending edits into strategic blueprint:

```typescript
export interface ApprovedBlueprintMetadata {
  approvedAt: string;
  hasUserEdits: boolean;
  editedSections: string[];
}

export function createApprovedBlueprint(
  original: StrategicBlueprintOutput,
  pendingEdits: Record<string, Record<string, unknown>>
): StrategicBlueprintOutput
```

Implementation:
1. Deep clone the original blueprint
2. For each section in pendingEdits, apply edits using a `setFieldAtPath` helper (copy from review.tsx or import)
3. Update metadata with approval info: add `approvedAt` timestamp, `hasUserEdits` boolean, `editedSections` array
4. Return the merged blueprint

Export `setFieldAtPath` as a named export so it can be reused (move from review.tsx if needed, or duplicate).

The function should be pure (no side effects) - just takes inputs and returns merged output.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Function exists, is properly typed, and compiles cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Wire approval into Continue flow and persist to localStorage</name>
  <files>src/components/strategic-research/review.tsx, src/app/generate/page.tsx, src/lib/storage/local-storage.ts</files>
  <action>
**In review.tsx:**
1. Update `StrategicResearchReviewProps` to add `onApprove: (approvedBlueprint: StrategicBlueprintOutput) => void`
2. Change `onComplete` to `onApprove` - when Continue clicked, create approved blueprint and call onApprove with it
3. Import `createApprovedBlueprint` from the new approval.ts
4. In the Continue button handler:
   - Call `createApprovedBlueprint(strategicBlueprint, pendingEdits)`
   - Pass result to `onApprove(approvedBlueprint)`

**In generate/page.tsx:**
1. Rename `handleReviewComplete` to `handleApprove`
2. Update signature: `handleApprove(approvedBlueprint: StrategicBlueprintOutput)`
3. Save approved blueprint to localStorage: `saveStrategicBlueprint(approvedBlueprint)`
4. Store in state: `setStrategicBlueprint(approvedBlueprint)`
5. Then transition to complete state: `setPageState("complete")`
6. Update the StrategicResearchReview usage to pass `onApprove={handleApprove}` instead of `onComplete`

**In local-storage.ts:**
No changes needed - `setStrategicBlueprint` already exists and handles saving.

**Button label update (optional but recommended):**
In review.tsx, consider changing button text from "Continue" to "Approve & Continue" when there are pending edits, to make it clear that clicking approves the changes.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
  </verify>
  <done>
- Review component calls onApprove with merged blueprint
- generate/page.tsx saves approved blueprint to localStorage
- State transitions correctly to complete
- No TypeScript errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Approval flow that merges edits and persists approved strategic blueprint</what-built>
  <how-to-verify>
    1. Run: `npm run dev`
    2. Visit: http://localhost:3000/generate
    3. Click "Auto-fill with Sample Data" to quickly populate the form
    4. Complete the onboarding wizard (click through all steps)
    5. Wait for Strategic Blueprint generation to complete
    6. In the Review screen:
       a. Expand the first section (Industry & Market Overview)
       b. Click "Edit" button
       c. Make a visible change to one of the text fields (e.g., change the category name)
       d. Click "Done" to exit edit mode
       e. Mark the section as reviewed
    7. Review remaining 4 sections (can just mark as reviewed without editing)
    8. Click "Continue" (or "Approve & Continue" if label was updated)
    9. Verify: Page transitions to complete state
    10. Open browser DevTools > Application > Local Storage
    11. Find `aigog_strategic_blueprint` key
    12. Verify: The saved JSON contains your edit (the changed category name)
    13. Verify: Metadata includes `approvedAt` timestamp and `hasUserEdits: true`
  </how-to-verify>
  <resume-signal>Type "approved" if edits persist correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds without errors
- [ ] User edits are merged into strategic blueprint on approval
- [ ] Approved blueprint is saved to localStorage
- [ ] Approval metadata includes timestamp and edit tracking
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- User can edit strategic research, approve changes, and see edits persisted
- Approved blueprint ready for future media plan generation integration
- Phase 7 complete - Milestone v1.1 Validation Gate finished
</success_criteria>

<output>
After completion, create `.planning/phases/07-approval-flow/07-01-SUMMARY.md`:

# Phase 7 Plan 1: Approval Flow Summary

**[Substantive one-liner]**

## Performance

- **Duration:** X min
- **Started:** YYYY-MM-DDTHH:MM:SSZ
- **Completed:** YYYY-MM-DDTHH:MM:SSZ
- **Tasks:** 3 (2 auto + 1 checkpoint)
- **Files modified:** N

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Deviations from Plan

[Any changes from the plan, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

- Milestone v1.1 complete
- Ready for v1.2 Persistence milestone
</output>
