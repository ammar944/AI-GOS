---
phase: 02-timeout-retry
plan: 01
type: execute
---

<objective>
Add per-section timeouts and exponential backoff retry to the OpenRouter client.

Purpose: Prevent hung requests and improve reliability with smart retry logic.
Output: Enhanced OpenRouter client with timeout and exponential backoff capabilities.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/STACK.md

**Prior decisions affecting this phase:**
- Use Zod for validation (Phase 1) - maintain compatibility
- 3+ sections = partial result (Phase 1) - timeout errors should trigger this

**Key files:**
@src/lib/openrouter/client.ts
@src/lib/media-plan/pipeline/media-plan-generator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timeout wrapper to OpenRouter client</name>
  <files>src/lib/openrouter/client.ts</files>
  <action>
Add a `timeout` option to `ChatCompletionOptions` interface (default: 45000ms).

Modify the `chat()` method to:
1. Create an AbortController
2. Set up a timeout that calls abort() after the specified duration
3. Pass the signal to the fetch() call
4. Clear the timeout on success
5. Throw a specific `TimeoutError` class when aborted due to timeout

Create a custom `TimeoutError` class that extends Error with:
- name: "TimeoutError"
- timeout: number (the timeout value)
- Distinguishable from other abort reasons

Do NOT use external libraries - use native AbortController and setTimeout.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>OpenRouter client accepts timeout option and aborts requests that exceed it</done>
</task>

<task type="auto">
  <name>Task 2: Convert retry to exponential backoff</name>
  <files>src/lib/openrouter/client.ts</files>
  <action>
Modify `chatJSON()` and `chatJSONValidated()` to use exponential backoff:

1. Add helper function `sleep(ms: number): Promise<void>`
2. Add helper function `calculateBackoff(attempt: number, baseDelay: number = 1000, maxDelay: number = 10000): number`
   - Formula: min(baseDelay * 2^attempt + random jitter, maxDelay)
   - Jitter: random 0-500ms to prevent thundering herd

3. Before each retry (not the first attempt):
   - Calculate backoff delay
   - Log: `[Retry] Attempt ${attempt + 1}, waiting ${delay}ms`
   - Wait the delay

4. Classify errors for retry decisions:
   - TimeoutError: RETRY (transient)
   - 429 Too Many Requests: RETRY with longer backoff
   - 500-599 Server Errors: RETRY (transient)
   - 400-499 Client Errors (except 429): NO RETRY (permanent)
   - Validation errors: RETRY (AI might fix on retry)

Do NOT retry indefinitely - respect the existing `retries` parameter (default: 2).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Retries use exponential backoff with jitter, errors are classified correctly</done>
</task>

<task type="auto">
  <name>Task 3: Add slow section detection</name>
  <files>src/lib/media-plan/pipeline/media-plan-generator.ts</files>
  <action>
Add slow section detection and logging to the media plan generator:

1. Define threshold constant: `SLOW_SECTION_THRESHOLD_MS = 30000` (30s)

2. After each section completes, check if it exceeded threshold:
   - If slow: `console.warn(\`[Slow Section] ${section} took ${time}ms (threshold: ${SLOW_SECTION_THRESHOLD_MS}ms)\`)`

3. Add timing stats to the result metadata:
   - `slowSections: string[]` - list of sections that exceeded threshold
   - `averageSectionTime: number` - average time per section

4. Pass timeout option to OpenRouter client calls:
   - Use 45000ms (45s) as default per-section timeout
   - This ensures no single section can hang forever
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Slow sections are logged with warnings, timing stats included in metadata</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] TimeoutError is properly thrown on timeout
- [ ] Exponential backoff delays are logged
- [ ] No breaking changes to existing API
</verification>

<success_criteria>
- TimeoutError class exists and is exported
- chat() method accepts and respects timeout option
- Retry uses exponential backoff with jitter
- Error classification determines retry behavior
- Slow sections are logged with timing data
</success_criteria>

<output>
After completion, create `.planning/phases/02-timeout-retry/02-01-SUMMARY.md`

Commit message format:
```
feat(02-01): timeout wrapper and exponential backoff for OpenRouter client
```
</output>
