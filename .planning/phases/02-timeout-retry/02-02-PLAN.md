---
phase: 02-timeout-retry
plan: 02
type: execute
---

<objective>
Add circuit breaker pattern and integrate timeout/retry into the generation pipeline.

Purpose: Prevent cascading failures and ensure graceful degradation.
Output: Resilient generation pipeline with circuit breaker protection.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-timeout-retry/02-01-SUMMARY.md

**Prior decisions affecting this phase:**
- Use Zod for validation (Phase 1)
- 3+ sections = partial result (Phase 1)
- Timeout and exponential backoff added (02-01)

**Key files:**
@src/lib/openrouter/client.ts
@src/lib/media-plan/pipeline/media-plan-generator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create circuit breaker utility</name>
  <files>src/lib/openrouter/circuit-breaker.ts</files>
  <action>
Create a new file `src/lib/openrouter/circuit-breaker.ts` with a CircuitBreaker class:

```typescript
interface CircuitBreakerOptions {
  failureThreshold: number;  // failures before opening (default: 3)
  resetTimeout: number;      // ms before trying again (default: 30000)
  name: string;              // identifier for logging
}

type CircuitState = 'CLOSED' | 'OPEN' | 'HALF_OPEN';
```

Implement:
1. `constructor(options: CircuitBreakerOptions)`
2. `async execute<T>(fn: () => Promise<T>): Promise<T>`
   - CLOSED: Execute function, track failures
   - OPEN: Throw CircuitOpenError immediately (don't execute)
   - HALF_OPEN: Try one request, if success -> CLOSED, if fail -> OPEN
3. `getState(): CircuitState`
4. `reset(): void` - Force reset to CLOSED

Create `CircuitOpenError` class extending Error with:
- name: "CircuitOpenError"
- circuitName: string
- nextRetryAt: Date

Log state transitions: `[CircuitBreaker:${name}] State changed: ${oldState} -> ${newState}`
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>CircuitBreaker class with CLOSED/OPEN/HALF_OPEN states, proper error handling</done>
</task>

<task type="auto">
  <name>Task 2: Integrate circuit breaker into generator</name>
  <files>src/lib/media-plan/pipeline/media-plan-generator.ts</files>
  <action>
Integrate circuit breaker into the media plan generator:

1. Import CircuitBreaker and CircuitOpenError from circuit-breaker.ts

2. Create a module-level circuit breaker instance:
   ```typescript
   const aiCircuitBreaker = new CircuitBreaker({
     failureThreshold: 3,
     resetTimeout: 60000,  // 1 minute
     name: 'MediaPlanAI'
   });
   ```

3. Wrap the AI call in each section with circuit breaker:
   ```typescript
   const response = await aiCircuitBreaker.execute(() =>
     client.chatJSONValidated(...)
   );
   ```

4. Handle CircuitOpenError specifically:
   - If circuit is open, immediately return partial result (if 3+ sections)
   - Log: `[Generator] Circuit breaker open - returning partial result`
   - Include in error message: "Service temporarily unavailable, please retry later"

5. Update MediaPlanGeneratorResult to include:
   - `circuitBreakerTripped: boolean`
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Circuit breaker wraps AI calls, CircuitOpenError triggers partial result return</done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end resilience</name>
  <files>src/lib/media-plan/pipeline/media-plan-generator.ts, src/lib/openrouter/client.ts</files>
  <action>
Verify the complete resilience chain works:

1. Ensure TimeoutError from client propagates correctly through circuit breaker

2. Add error cause chain - wrap errors with context:
   ```typescript
   catch (error) {
     const wrappedError = new Error(`Section ${section} failed: ${error.message}`);
     wrappedError.cause = error;
     throw wrappedError;
   }
   ```

3. Update the partial result logic to handle new error types:
   - TimeoutError -> Include "timeout" in error message
   - CircuitOpenError -> Include "service unavailable" in error message
   - Validation errors -> Include "validation failed" in error message

4. Ensure metadata includes:
   - `failureReason: 'timeout' | 'circuit_open' | 'validation' | 'api_error' | 'unknown'`

5. Add summary log at end of generation:
   ```typescript
   console.log(`[Generator] Complete: ${completedSections.length}/${totalSections} sections, ${totalTime}ms, ${totalCost.toFixed(4)} USD`);
   ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
  </verify>
  <done>Error chain preserved, failure reasons categorized, summary logging added</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] CircuitBreaker transitions states correctly
- [ ] Partial results returned when circuit opens
- [ ] Error messages are descriptive and actionable
- [ ] Phase 2 complete - all timeout/retry logic implemented
</verification>

<success_criteria>
- CircuitBreaker class exists with 3 states
- Generator uses circuit breaker for AI calls
- CircuitOpenError triggers partial result return
- Error messages include failure reason
- Metadata includes failure categorization
- All Phase 2 roadmap tasks complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-timeout-retry/02-02-SUMMARY.md`

Commit message format:
```
feat(02-02): circuit breaker pattern for resilient media plan generation
```
</output>
