---
phase: 20-unit-tests-core
plan: 02
type: execute
---

<objective>
Unit tests for Zod schema validation covering media plan section schemas.

Purpose: Ensure the 11 media plan section schemas correctly validate AI responses, catching malformed data before it reaches the UI.
Output: Test file with schema validation tests for all section types.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior decisions affecting this phase:**
- Phase 01-01: Use passthrough() for AI flexibility (allow extra fields)
- Phase 19-02: Parameterized tests (it.each) for mapping functions

@src/lib/media-plan/schemas.ts
@src/lib/openrouter/__tests__/json-extraction.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test enum schemas and Section 1-4 schemas</name>
  <files>src/lib/media-plan/__tests__/schemas.test.ts</files>
  <action>
Create tests for enum schemas and first 4 section schemas:

**Enum schemas (use it.each for valid/invalid values):**
- businessGoalSchema: valid ("revenue_growth", etc.) and invalid ("invalid_goal")
- marketingObjectiveSchema: valid ("awareness", etc.) and invalid
- targetingMethodSchema: all 10 valid values
- platformNameSchema: all 12 platforms
- funnelStageSchema: "tofu", "mofu", "bofu"
- audienceTemperatureSchema: "cold", "warm", "hot"
- riskSeveritySchema and riskLikelihoodSchema

**Section schemas:**

1. **executiveSummarySchema:**
   - Valid minimal object with all required fields
   - Missing required field (strategyOverview) → should fail
   - Extra fields allowed (passthrough)

2. **campaignObjectiveSelectionSchema:**
   - Valid nested object with businessGoal.goal enum
   - Invalid businessGoal.goal enum value → should fail
   - platformLogic nested object validation

3. **keyInsightsFromResearchSchema:**
   - Valid with topInsights array of strategicInsightSchema
   - strategicInsightSchema category enum validation
   - Nested painPoints, differentiation objects

4. **icpAndTargetingStrategySchema:**
   - Valid with audienceSegmentSchema (priority enum)
   - targetingMethods array with targetingMethodSchema enum
   - Nested demographics, psychographics, professional objects

**Test structure:**
```typescript
import { describe, it, expect } from "vitest";
import * as schemas from "../schemas";

describe("Media Plan Schemas", () => {
  describe("Enum Schemas", () => {
    describe("businessGoalSchema", () => {
      it.each([
        "revenue_growth",
        "lead_generation",
        // ... all valid values
      ])("accepts valid value: %s", (value) => {
        expect(schemas.businessGoalSchema.safeParse(value).success).toBe(true);
      });

      it("rejects invalid value", () => {
        expect(schemas.businessGoalSchema.safeParse("invalid").success).toBe(false);
      });
    });
  });
});
```
  </action>
  <verify>npm test -- src/lib/media-plan/__tests__/schemas.test.ts</verify>
  <done>Enum schemas and Section 1-4 schemas tested with valid/invalid cases</done>
</task>

<task type="auto">
  <name>Task 2: Test Section 5-8 schemas</name>
  <files>src/lib/media-plan/__tests__/schemas.test.ts</files>
  <action>
Add tests for sections 5-8:

5. **platformAndChannelStrategySchema:**
   - Valid platforms array with platformStrategySchema
   - platformNameSchema and platformRoleSchema enums
   - primaryPlatform nested object
   - priorityOrder array of platformNameSchema

6. **funnelStrategySchema:**
   - Valid stages array with funnelStageConfigSchema
   - funnelStageSchema enum in stage field
   - landingPageRequirements nested object
   - retargetingPaths with window enum ("7_day", etc.)

7. **creativeStrategySchema:**
   - Valid primaryAngles array with creativeAngleSchema
   - funnelStage enum in angles
   - testingPlan nested object with variablesToTest
   - brandGuidelines nested object

8. **campaignStructureSchema:**
   - Valid coldStructure/warmStructure/hotStructure arrays
   - campaignStructureSegmentSchema with audienceTemperatureSchema
   - scalingStructure with scalingTriggers array
   - namingConventions with UTM structure

**Test pattern for nested objects:**
```typescript
describe("platformAndChannelStrategySchema", () => {
  const validPlatform: z.infer<typeof schemas.platformStrategySchema> = {
    platform: "meta",
    role: "primary_acquisition",
    whySelected: ["Large audience"],
    expectedContribution: [{ metric: "Leads", contribution: "40%", percentage: 40 }],
    tactics: ["Retargeting"],
    campaignTypes: ["Conversions"],
    adFormats: ["Image"],
    placements: ["Feed"],
    bestPractices: ["Test creative"],
  };

  it("accepts valid platform strategy", () => {
    expect(schemas.platformStrategySchema.safeParse(validPlatform).success).toBe(true);
  });
});
```
  </action>
  <verify>npm test -- src/lib/media-plan/__tests__/schemas.test.ts</verify>
  <done>Section 5-8 schemas tested with valid structures and enum validation</done>
</task>

<task type="auto">
  <name>Task 3: Test Section 9-11 and complete mediaPlanOutputSchema</name>
  <files>src/lib/media-plan/__tests__/schemas.test.ts</files>
  <action>
Add tests for sections 9-11 and the complete output schema:

9. **kpisAndPerformanceModelSchema:**
   - Valid primaryKpis/secondaryKpis arrays
   - kpiDefinitionSchema with reportingFrequency enum
   - cacModel with targetCac number
   - breakEvenMath nested object
   - metricsSchedule with daily/weekly/monthly arrays

10. **budgetAllocationAndScalingSchema:**
   - Valid initialBudget nested object
   - platformAllocation array with numbers
   - funnelAllocation with funnelStageSchema enum
   - scalingRules with riskLevel enum
   - monthlyRoadmap array

11. **risksAndMitigationSchema:**
   - Valid topRisks array with riskSchema
   - riskCategorySchema, riskSeveritySchema, riskLikelihoodSchema enums
   - mitigationSteps with timing enum
   - dependencies with type and status enums

**mediaPlanMetadataSchema:**
- Valid with generatedAt, version, processingTime
- Optional fields (inputHash, validUntil)

**Complete mediaPlanOutputSchema:**
- Valid complete object with all 11 sections + metadata
- Missing section → should fail
- Partial object → should fail

**MEDIA_PLAN_SECTION_SCHEMAS constant:**
- Contains all 11 section schemas
- Keys match section names
  </action>
  <verify>npm test -- src/lib/media-plan/__tests__/schemas.test.ts</verify>
  <done>All 11 section schemas tested, complete output schema validated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- src/lib/media-plan/__tests__/schemas.test.ts` passes all tests
- [ ] All enum schemas have valid/invalid value tests
- [ ] All 11 section schemas have structure tests
- [ ] Complete mediaPlanOutputSchema tested
</verification>

<success_criteria>
- All tests pass
- Enum schemas reject invalid values
- Nested object validation works correctly
- passthrough() allows extra fields
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-unit-tests-core/20-02-SUMMARY.md`
</output>
