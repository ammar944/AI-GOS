---
phase: 20-unit-tests-core
plan: 03
type: execute
---

<objective>
Unit tests for utility functions: localStorage operations and OpenRouter model capability helpers.

Purpose: Test the storage layer that persists generation data and the model capability functions that determine API behavior.
Output: Test files for local-storage.ts and OpenRouter model helpers.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior decisions affecting this phase:**
- Phase 19-02: vi.useFakeTimers for time-dependent tests
- Phase 19-01: jsdom environment provides localStorage

@src/lib/storage/local-storage.ts
@src/lib/openrouter/client.ts
@src/test/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test localStorage utility functions</name>
  <files>src/lib/storage/__tests__/local-storage.test.ts</files>
  <action>
Create comprehensive tests for localStorage operations:

**Setup/teardown:**
```typescript
import { describe, it, expect, beforeEach, afterEach } from "vitest";
import * as storage from "../local-storage";

describe("LocalStorage", () => {
  beforeEach(() => {
    localStorage.clear();
  });

  afterEach(() => {
    localStorage.clear();
  });
});
```

**STORAGE_KEYS constant:**
- Verify all keys are defined
- Keys follow naming convention (aigog_*)

**Generic operations (test through specific functions):**
- getOnboardingData: returns null when empty, returns data when set
- setOnboardingData: stores data, returns true on success
- getStrategicBlueprint: returns null when empty, returns data when set
- setStrategicBlueprint: stores data, updates generation state
- getMediaPlan: returns null when empty
- setMediaPlan: stores data, updates generation state

**GenerationState tracking:**
- setOnboardingData → state.currentStage = "onboarding"
- setStrategicBlueprint → state.currentStage = "blueprint-complete"
- setMediaPlan → state.currentStage = "plan-complete"
- getGenerationState returns correct state and lastUpdated

**Error handling (mock localStorage failures):**
```typescript
it("handles localStorage.setItem failure gracefully", () => {
  const originalSetItem = localStorage.setItem;
  localStorage.setItem = () => { throw new Error("QuotaExceeded"); };

  const result = storage.setOnboardingData({ /* mock data */ });
  expect(result).toBe(false);

  localStorage.setItem = originalSetItem;
});
```
  </action>
  <verify>npm test -- src/lib/storage/__tests__/local-storage.test.ts</verify>
  <done>Core localStorage get/set operations tested with state tracking</done>
</task>

<task type="auto">
  <name>Task 2: Test localStorage utility functions (hasSavedProgress, getSavedProgress, clear functions)</name>
  <files>src/lib/storage/__tests__/local-storage.test.ts</files>
  <action>
Add tests for utility functions:

**hasSavedProgress:**
- Returns false when no state exists
- Returns false when state.currentStage = "onboarding"
- Returns true when state.currentStage = "blueprint-complete"
- Returns true when state.currentStage = "plan-complete"

**getSavedProgress:**
- Returns all null when nothing saved
- Returns populated object when data exists
- Returns partial data (some null, some populated)

**clearAllSavedData:**
- Removes all 4 keys
- Returns true on success
- hasSavedProgress returns false after clear

**clearMediaPlan:**
- Removes only media plan
- Keeps onboarding and blueprint data
- Updates state to "blueprint-complete" if blueprint exists

**clearBlueprintAndPlan:**
- Removes blueprint and plan
- Keeps onboarding data
- Updates state to "onboarding"

**Test data factories:**
```typescript
function createMockOnboardingData(): OnboardingFormData {
  return {
    // minimal valid structure
  };
}

function createMockBlueprint(): StrategicBlueprintOutput {
  return {
    // minimal valid structure
  };
}
```

Note: May need to create minimal mock factories or import from src/test/utils.ts if already available.
  </action>
  <verify>npm test -- src/lib/storage/__tests__/local-storage.test.ts</verify>
  <done>All utility functions tested including clear operations and state management</done>
</task>

<task type="auto">
  <name>Task 3: Test OpenRouter model capability helpers</name>
  <files>src/lib/openrouter/__tests__/model-capabilities.test.ts</files>
  <action>
Create tests for model capability functions:

**MODELS constant:**
- All model identifiers are strings
- Values match OpenRouter model ID format

**supportsReasoning(model):**
```typescript
describe("supportsReasoning", () => {
  it.each([
    MODELS.O3_MINI,
    MODELS.GEMINI_25_FLASH,
    MODELS.CLAUDE_OPUS,
    MODELS.PERPLEXITY_DEEP_RESEARCH,
  ])("returns true for reasoning model: %s", (model) => {
    expect(supportsReasoning(model)).toBe(true);
  });

  it.each([
    MODELS.GEMINI_FLASH,
    MODELS.GPT_4O,
    MODELS.CLAUDE_SONNET,
    MODELS.PERPLEXITY_SONAR,
  ])("returns false for non-reasoning model: %s", (model) => {
    expect(supportsReasoning(model)).toBe(false);
  });

  it("returns false for unknown model", () => {
    expect(supportsReasoning("unknown/model")).toBe(false);
  });
});
```

**hasWebSearch(model):**
- Returns true for PERPLEXITY_SONAR and PERPLEXITY_DEEP_RESEARCH
- Returns false for all other models
- Returns false for unknown model

**supportsJSONMode(model):**
- Returns true for: GEMINI_FLASH, GPT_4O, CLAUDE_SONNET, CLAUDE_OPUS, O3_MINI, GEMINI_25_FLASH
- Returns false for: PERPLEXITY_SONAR, PERPLEXITY_DEEP_RESEARCH (Perplexity doesn't support response_format)
- Returns false for unknown model

**extractCitations(response):**
- Returns citations from searchResults (preferred format)
- Falls back to citations array (legacy format)
- Returns empty array when no citations
- Maps searchResults to Citation type correctly
  </action>
  <verify>npm test -- src/lib/openrouter/__tests__/model-capabilities.test.ts</verify>
  <done>Model capability helpers tested with parameterized tests for all models</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- src/lib/storage/__tests__/local-storage.test.ts` passes all tests
- [ ] `npm test -- src/lib/openrouter/__tests__/model-capabilities.test.ts` passes all tests
- [ ] localStorage operations handle errors gracefully
- [ ] Model capabilities match documented behavior
</verification>

<success_criteria>
- All tests pass
- localStorage SSR safety (returns null/false when window undefined)
- Generation state transitions correctly
- Model capability sets are accurate
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-unit-tests-core/20-03-SUMMARY.md`
</output>
