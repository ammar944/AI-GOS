---
phase: 20-unit-tests-core
plan: 01
type: execute
---

<objective>
Comprehensive unit tests for OpenRouter JSON extraction logic (extractJSON, extractBalancedJSON, repairJSON, isValidJSON).

Purpose: The JSON extraction logic is critical infrastructure that handles 8 extraction strategies plus repair logic. Comprehensive test coverage ensures reliable AI response parsing.
Output: Test file with 40+ tests covering all extraction strategies and edge cases.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior decisions affecting this phase:**
- Phase 19-01: Vitest 4.0 with jsdom environment established
- Phase 19-02: AAA pattern and parameterized tests (it.each) established

@src/lib/openrouter/client.ts
@src/test/mocks/openrouter.ts
@src/lib/openrouter/__tests__/circuit-breaker.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test extractJSON Strategy 1-3 (direct parse, balanced object, balanced array)</name>
  <files>src/lib/openrouter/__tests__/json-extraction.test.ts</files>
  <action>
Create comprehensive tests for the first three JSON extraction strategies:

1. **Strategy 1 - Direct parse:**
   - Valid JSON object: `{"key": "value"}`
   - Valid JSON array: `[1, 2, 3]`
   - Empty object: `{}`
   - Nested structures
   - Returns null for primitives (number, string, boolean, null)

2. **Strategy 2 - Balanced object extraction:**
   - JSON with trailing text: `{"a": 1} some extra text`
   - JSON with leading whitespace
   - Nested objects with proper balance
   - Handles escaped quotes in strings

3. **Strategy 3 - Balanced array extraction:**
   - Array with trailing text: `[1, 2, 3] extra`
   - Nested arrays
   - Mixed arrays with objects

**Test structure:**
```typescript
import { describe, it, expect } from "vitest";

// Need to expose private methods for testing
// Create a test-specific subclass or use reflection
```

Note: extractJSON and related methods are private. Options:
a) Test through chatJSON (integration-style)
b) Create test helper that exposes methods
c) Make methods protected and create test subclass

Recommend option (c) - minimal change, clean testing. Change `private extractJSON` to `protected extractJSON` in client.ts, create `TestableOpenRouterClient extends OpenRouterClient` in test file.
  </action>
  <verify>npm test -- src/lib/openrouter/__tests__/json-extraction.test.ts</verify>
  <done>Strategy 1-3 tests pass, covering direct parse, balanced object, and balanced array extraction</done>
</task>

<task type="auto">
  <name>Task 2: Test extractJSON Strategy 4-6 (markdown code blocks, find-first-brace, find-first-bracket)</name>
  <files>src/lib/openrouter/__tests__/json-extraction.test.ts</files>
  <action>
Add tests for strategies 4-6:

4. **Strategy 4 - Markdown code blocks:**
   - ` ```json\n{"a": 1}\n``` `
   - ` ```\n{"a": 1}\n``` ` (no language tag)
   - Code block with extra whitespace
   - Code block with unbalanced JSON (should try balanced extraction)

5. **Strategy 5 - Find first brace:**
   - Text before JSON: `Here is the data: {"key": "value"}`
   - Multiple braces (should find outermost balanced)
   - JSON in middle of text

6. **Strategy 6 - Find first bracket:**
   - Text before array: `Results: [1, 2, 3]`
   - Array in middle of text

Also test priority: if both { and [ exist, should prefer whichever comes first.
  </action>
  <verify>npm test -- src/lib/openrouter/__tests__/json-extraction.test.ts</verify>
  <done>Strategy 4-6 tests pass, covering markdown blocks and find-first extraction</done>
</task>

<task type="auto">
  <name>Task 3: Test extractJSON Strategy 7-8 and repairJSON</name>
  <files>src/lib/openrouter/__tests__/json-extraction.test.ts</files>
  <action>
Add tests for repair strategies and edge cases:

7. **Strategy 7 - Repair on unbalanced:**
   - Truncated JSON: `{"a": 1, "b": 2` (missing closing brace)
   - Truncated array: `[1, 2, 3` (missing closing bracket)
   - Truncated in string: `{"a": "hello...`
   - Multiple levels of nesting truncated

8. **Strategy 8 - Greedy extraction with repair:**
   - Severely malformed: `result: {"a": 1} end`
   - Mixed brackets/braces in text

**repairJSON specific tests:**
- Trailing commas: `{"a": 1,}` → `{"a": 1}`
- Trailing commas in arrays: `[1, 2,]` → `[1, 2]`
- Control characters in strings (newlines, tabs)
- Truncated mid-property: `{"a": 1, "b":` → should remove incomplete property
- Unclosed string: `{"a": "hello` → should close string and object

**isValidJSON tests:**
- null input → false
- non-string input → false
- primitive values → false
- valid object → true
- valid array → true
- invalid JSON string → false

**Edge cases:**
- Empty string → null
- Whitespace only → null
- All strategies fail → null
  </action>
  <verify>npm test -- src/lib/openrouter/__tests__/json-extraction.test.ts</verify>
  <done>All 8 strategies + repair logic + edge cases tested with 40+ tests total</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- src/lib/openrouter/__tests__/json-extraction.test.ts` passes all tests
- [ ] Coverage of all 8 extraction strategies
- [ ] repairJSON edge cases covered
- [ ] isValidJSON boundary conditions covered
</verification>

<success_criteria>
- All tests pass (40+ tests)
- All 8 extraction strategies have test coverage
- Repair logic handles common AI malformations
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-unit-tests-core/20-01-SUMMARY.md`
</output>
