---
phase: 13-sections23-enhancement
plan: 1
type: execute
---

<objective>
Enhance Sections 2-3 (ICP Analysis + Offer Analysis) with Perplexity Deep Research for real-time verified data with citations.

Purpose: Replace static AI generation with web-searched market intelligence for ICP validation and offer viability assessment.
Output: Two new research modules (`icp-research.ts`, `offer-research.ts`) integrated into the strategic blueprint generator.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior decisions affecting this phase:**
- Phase 11: Use `agent.research()` instead of `researchJSON()` to preserve citations
- Phase 11: 120s timeout for deep research (multi-step web search takes longer)
- Phase 11: Defensive JSON validation with fallback defaults for enums
- Phase 12: Copy JSON extraction helpers (extractJSON, extractBalancedJSON, isValidJSON) for consistency

**Pattern files to follow:**
@src/lib/strategic-blueprint/pipeline/competitor-research.ts
@src/lib/strategic-blueprint/pipeline/industry-market-research.ts
@src/lib/strategic-blueprint/pipeline/strategic-blueprint-generator.ts
@src/lib/strategic-blueprint/output-types.ts

**Section 2 (ICPAnalysisValidation) key types:**
- ValidationStatus: "validated" | "workable" | "invalid"
- RiskRating: "low" | "medium" | "high" | "critical"
- PainSolutionFit.fitAssessment: "strong" | "moderate" | "weak"

**Section 3 (OfferAnalysisViability) key types:**
- OfferRedFlag: "offer_too_vague" | "overcrowded_market" | "price_mismatch" | "weak_or_no_proof" | "no_funnel_built" | "transformation_unclear"
- OfferRecommendation: "proceed" | "adjust_messaging" | "adjust_pricing" | "icp_refinement_needed" | "major_offer_rebuild"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ICP research function</name>
  <files>src/lib/strategic-blueprint/pipeline/icp-research.ts</files>
  <action>
Create `researchICPAnalysis()` function following Phase 11-12 patterns:

1. Import: `createResearchAgent` from `@/lib/research`, `MODELS` from `@/lib/openrouter/client`, types from `../output-types`
2. Export async function `researchICPAnalysis(context: string, industryMarketOverview?: IndustryMarketOverview): Promise<CitedSectionOutput<ICPAnalysisValidation>>`
3. System prompt: Expert ICP analyst with web search - research actual audience data from LinkedIn, industry reports, market research
4. Include context from industryMarketOverview if provided (pain points, market maturity, buying behavior)
5. User prompt: Research ICP validation for the business context
6. Use `agent.research()` with MODELS.PERPLEXITY_DEEP_RESEARCH, 120s timeout, jsonMode: true
7. Parse JSON with `parseICPAnalysisJSON()` function
8. Validation helpers:
   - `validateValidationStatus()` → default "workable"
   - `validateRiskRating()` → default "medium"
   - `validateFitAssessment()` → default "moderate"
9. Include JSON extraction helpers (copy from industry-market-research.ts)
10. Return CitedSectionOutput<ICPAnalysisValidation>
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>icp-research.ts created with researchICPAnalysis() function and defensive validation</done>
</task>

<task type="auto">
  <name>Task 2: Create Offer research function</name>
  <files>src/lib/strategic-blueprint/pipeline/offer-research.ts</files>
  <action>
Create `researchOfferAnalysis()` function following Phase 11-12 patterns:

1. Import: `createResearchAgent` from `@/lib/research`, `MODELS` from `@/lib/openrouter/client`, types from `../output-types`
2. Export async function `researchOfferAnalysis(context: string, icpAnalysis?: ICPAnalysisValidation): Promise<CitedSectionOutput<OfferAnalysisViability>>`
3. System prompt: Expert offer analyst with web search - research pricing benchmarks, competitor offers, market expectations
4. Include context from icpAnalysis if provided (ICP status, pain-solution fit, primary pain)
5. User prompt: Analyze offer viability for the business context
6. Use `agent.research()` with MODELS.PERPLEXITY_DEEP_RESEARCH, 120s timeout, jsonMode: true
7. Parse JSON with `parseOfferAnalysisJSON()` function
8. Validation helpers:
   - `validateOfferRedFlag()` → filter invalid values from array
   - `validateOfferRecommendation()` → default "adjust_messaging"
   - Score validation: clamp 1-10, calculate overallScore as average
9. Include JSON extraction helpers (copy from industry-market-research.ts)
10. Return CitedSectionOutput<OfferAnalysisViability>
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>offer-research.ts created with researchOfferAnalysis() function and defensive validation</done>
</task>

<task type="auto">
  <name>Task 3: Integrate into strategic blueprint generator</name>
  <files>src/lib/strategic-blueprint/pipeline/strategic-blueprint-generator.ts</files>
  <action>
Update generator to use new research functions for Sections 2-3:

1. Add imports:
   ```typescript
   import { researchICPAnalysis } from "./icp-research";
   import { researchOfferAnalysis } from "./offer-research";
   ```

2. In the section loop, add special handling for icpAnalysisValidation (after industryMarketOverview handling):
   ```typescript
   if (section === "icpAnalysisValidation") {
     const result = await researchICPAnalysis(context, partialOutput.industryMarketOverview);
     partialOutput[section] = result.data;
     sectionCitations[section] = result.citations;
     totalCost += result.cost;
     modelsUsed.add(MODELS.PERPLEXITY_DEEP_RESEARCH);
     sectionTimings[section] = Date.now() - sectionStart;
     completedSections.push(section);
     updateProgress(section, `Completed ${STRATEGIC_BLUEPRINT_SECTION_LABELS[section]} (with ${result.citations.length} citations)`);
     continue;
   }
   ```

3. Add similar handling for offerAnalysisViability (after icpAnalysisValidation handling):
   ```typescript
   if (section === "offerAnalysisViability") {
     const result = await researchOfferAnalysis(context, partialOutput.icpAnalysisValidation);
     partialOutput[section] = result.data;
     sectionCitations[section] = result.citations;
     totalCost += result.cost;
     modelsUsed.add(MODELS.PERPLEXITY_DEEP_RESEARCH);
     sectionTimings[section] = Date.now() - sectionStart;
     completedSections.push(section);
     updateProgress(section, `Completed ${STRATEGIC_BLUEPRINT_SECTION_LABELS[section]} (with ${result.citations.length} citations)`);
     continue;
   }
   ```

4. Now only crossAnalysisSynthesis uses Claude Sonnet (other 4 sections use Perplexity Deep Research)
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Build succeeds: `npm run build`
  </verify>
  <done>Generator uses Perplexity Deep Research for Sections 1-4, Claude Sonnet only for Section 5 synthesis</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] icp-research.ts exists with proper validation
- [ ] offer-research.ts exists with proper validation
- [ ] Generator imports and uses both new research functions
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Sections 2-3 now use Perplexity Deep Research with citations
- Defensive validation for all enum values
- Pattern consistency with Phase 11-12 implementations
</success_criteria>

<output>
After completion, create `.planning/phases/13-sections23-enhancement/13-01-SUMMARY.md`:

# Phase 13 Plan 1: Sections 2-3 Enhancement Summary

**[Substantive one-liner - what shipped]**

## Performance

- **Duration:** X min
- **Tasks:** 3
- **Files created/modified:** 3

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/lib/strategic-blueprint/pipeline/icp-research.ts` - Description
- `src/lib/strategic-blueprint/pipeline/offer-research.ts` - Description
- `src/lib/strategic-blueprint/pipeline/strategic-blueprint-generator.ts` - Description

## Decisions Made

[Key decisions and rationale]

## Deviations from Plan

[Any deviations, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 13 complete, ready for Phase 14 (Citations UI & Cost Tracking)

---
*Phase: 13-sections23-enhancement*
*Completed: YYYY-MM-DD*
</output>
