---
phase: 03-vercel-deployment
plan: 01
type: execute
---

<objective>
Configure all API routes for Vercel deployment limits and add operational endpoints.

Purpose: Ensure the application works reliably on Vercel Pro tier without runtime timeouts.
Output: All routes configured with appropriate maxDuration, health check endpoint, environment validation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STACK.md
@.planning/codebase/ARCHITECTURE.md

**Prior decisions affecting this phase:**
- Phase 2 implemented 45s per-section timeout with circuit breaker
- OpenRouter client has configurable timeout (default 45s)
- Some routes already have maxDuration = 300 (5 min)

**Vercel constraints:**
- Pro tier: 60s default, up to 300s with maxDuration export
- Hobby tier: 10s max (not our target)
- Environment variables loaded from Vercel dashboard

**Relevant source files:**
@src/app/api/media-plan/generate/route.ts
@src/app/api/media-plan/full-plan/route.ts
@src/app/api/strategic-blueprint/generate/route.ts
@next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and configure route timeouts</name>
  <files>src/app/api/media-plan/generate/route.ts, src/app/api/media-plan/full-plan/route.ts, src/app/api/strategic-blueprint/generate/route.ts</files>
  <action>
    1. Add `export const maxDuration = 300;` to `/api/media-plan/generate/route.ts` (currently missing)
    2. Verify `/api/media-plan/full-plan/route.ts` has maxDuration = 300 (already present)
    3. Verify `/api/strategic-blueprint/generate/route.ts` has maxDuration = 300 (already present)
    4. Add comment explaining Vercel Pro tier requirement above each export

    Note: 300s (5 min) is the maximum for Vercel Pro. This accommodates 11 sections Ã— 45s timeout + retries.
  </action>
  <verify>grep -r "maxDuration" src/app/api/ shows all three generation routes have maxDuration = 300</verify>
  <done>All generation routes configured with maxDuration = 300 and explanatory comments</done>
</task>

<task type="auto">
  <name>Task 2: Add health check endpoint</name>
  <files>src/app/api/health/route.ts</files>
  <action>
    Create GET /api/health endpoint that returns:
    - status: "ok" | "degraded" | "error"
    - timestamp: ISO string
    - version: from package.json (optional, can hardcode)
    - checks: object with individual check results

    Checks to perform:
    1. Environment: Verify OPENROUTER_API_KEY is set (don't expose value)
    2. Environment: Verify NEXT_PUBLIC_SUPABASE_URL is set
    3. Environment: Verify NEXT_PUBLIC_SUPABASE_ANON_KEY is set

    Return 200 for ok/degraded, 503 for error.

    Keep it simple - no external API calls (those would add latency and could fail).
  </action>
  <verify>curl http://localhost:3000/api/health returns JSON with status "ok" and all checks passing</verify>
  <done>Health endpoint returns structured response with environment checks</done>
</task>

<task type="auto">
  <name>Task 3: Add startup environment validation</name>
  <files>src/lib/env.ts</files>
  <action>
    Create environment validation utility:

    1. Define required environment variables:
       - OPENROUTER_API_KEY (server-only)
       - NEXT_PUBLIC_SUPABASE_URL (public)
       - NEXT_PUBLIC_SUPABASE_ANON_KEY (public)
       - NEXT_PUBLIC_APP_URL (public, optional)

    2. Create `validateEnv()` function that:
       - Checks each required var is set and non-empty
       - Returns { valid: boolean, missing: string[] }
       - Logs warning if optional vars missing

    3. Create `getEnv(key)` helper for type-safe access

    Note: Do NOT throw on missing env vars - the health endpoint will surface this.
    This allows the app to start and report its health status rather than crash.
  </action>
  <verify>Import validateEnv in health route and verify it correctly identifies missing/present env vars</verify>
  <done>Environment validation utility created with validateEnv() and getEnv() functions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] All three generation routes have maxDuration = 300
- [ ] GET /api/health returns 200 with status checks
- [ ] Health endpoint correctly reports env var status
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Health endpoint functional
- Ready for Vercel deployment testing
</success_criteria>

<output>
After completion, create `.planning/phases/03-vercel-deployment/03-01-SUMMARY.md`

Commit message format:
```
feat(03-01): Vercel deployment configuration with health check

- Add maxDuration=300 to all generation routes
- Create /api/health endpoint with env checks
- Add environment validation utility
```
</output>
