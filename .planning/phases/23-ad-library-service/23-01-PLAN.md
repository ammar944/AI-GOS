# Plan 23-01: Ad Library Service

**Phase:** 23 - Ad Library Service
**Goal:** SearchAPI.io integration for all 3 platforms (LinkedIn, Meta, Google Ads Transparency)
**Depends on:** v1.7 complete (but can be started in parallel since APIs are already tested)

## Context

The Ad Library APIs have been tested in `test-ad-libraries-local.ts` with successful results:
- **LinkedIn Ad Library:** 27,818+ ads found, images via `ad.content?.image`
- **Meta Ad Library:** 7,786+ ads found, images via `ad.snapshot?.images[]` (can be string or object)
- **Google Ads Transparency:** 20,000+ ads found, uses `ad_creatives` array, images via `ad.image?.link`

This service will provide a unified interface to fetch competitor ads from all three platforms for integration into Section 4 (Competitor Analysis) of the Strategic Blueprint.

## Discovery

**Level:** 0 (Skip) - APIs already tested and validated in test script

**Findings from test-ad-libraries-local.ts:**
- All three APIs work via SearchAPI.io
- Different field names and structures per platform
- Image URLs need platform-specific extraction
- Rate limiting considerations for production use

## Tasks

### Task 1: Create AdLibraryService types and interfaces
**File:** `src/lib/ad-library/types.ts`

Define unified types for ad library operations:

```typescript
// Platform types
export type AdPlatform = 'linkedin' | 'meta' | 'google';

// Unified ad creative interface
export interface AdCreative {
  platform: AdPlatform;
  id: string;
  advertiser: string;
  headline?: string;
  body?: string;
  imageUrl?: string;
  videoUrl?: string;
  isActive: boolean;
  firstSeen?: string;
  lastSeen?: string;
  platforms?: string[]; // For Meta (Facebook, Instagram, etc.)
  detailsUrl?: string;
  rawData: unknown; // Original API response
}

// Fetch options
export interface AdLibraryOptions {
  query: string; // Company name for LinkedIn/Meta
  domain?: string; // Domain for Google Ads Transparency
  limit?: number; // Max ads to fetch per platform
  country?: string; // Country filter (default: US)
}

// Response with multiple platforms
export interface AdLibraryResponse {
  platform: AdPlatform;
  success: boolean;
  ads: AdCreative[];
  totalCount: number;
  error?: string;
}

// Aggregated response
export interface MultiPlatformAdResponse {
  results: AdLibraryResponse[];
  totalAds: number;
  hasCreatives: boolean;
}
```

**Verification:** TypeScript compiles without errors

---

### Task 2: Create AdLibraryService class
**File:** `src/lib/ad-library/service.ts`

Implement the service class with methods for each platform:

```typescript
import { getRequiredEnv } from '@/lib/env';
import type {
  AdPlatform,
  AdCreative,
  AdLibraryOptions,
  AdLibraryResponse,
  MultiPlatformAdResponse,
} from './types';

const SEARCHAPI_BASE = 'https://www.searchapi.io/api/v1/search';

export class AdLibraryService {
  private apiKey: string;

  constructor() {
    this.apiKey = getRequiredEnv('SEARCHAPI_KEY');
  }

  // LinkedIn Ad Library
  async fetchLinkedInAds(options: AdLibraryOptions): Promise<AdLibraryResponse>

  // Meta Ad Library (Facebook/Instagram)
  async fetchMetaAds(options: AdLibraryOptions): Promise<AdLibraryResponse>

  // Google Ads Transparency Center
  async fetchGoogleAds(options: AdLibraryOptions): Promise<AdLibraryResponse>

  // Fetch from all platforms in parallel
  async fetchAllPlatforms(options: AdLibraryOptions): Promise<MultiPlatformAdResponse>

  // Helper: Extract image URL from platform-specific format
  private extractImageUrl(platform: AdPlatform, ad: unknown): string | undefined

  // Helper: Normalize ad to unified format
  private normalizeAd(platform: AdPlatform, rawAd: unknown): AdCreative
}

export function createAdLibraryService(): AdLibraryService {
  return new AdLibraryService();
}
```

Key implementation details:
- Use `fetch()` with proper error handling
- 30s timeout per API call
- Normalize different API response formats to unified `AdCreative`
- Handle image URL extraction per platform:
  - LinkedIn: `ad.content?.image`
  - Meta: `ad.snapshot?.images[0]` (check if string or object with `url` field)
  - Google: `ad.image?.link`

**Verification:**
- `npm run lint` passes
- `npm run build` passes

---

### Task 3: Add SEARCHAPI_KEY to environment configuration
**File:** `src/lib/env.ts`

Add SEARCHAPI_KEY to the server environment variables:

```typescript
const REQUIRED_ENV_VARS = {
  server: ["OPENROUTER_API_KEY", "SEARCHAPI_KEY"] as const,
  // ... rest unchanged
}
```

Also add to `.env.example` if it exists.

**Verification:** Environment validation includes SEARCHAPI_KEY

---

### Task 4: Create service barrel export
**File:** `src/lib/ad-library/index.ts`

```typescript
export { AdLibraryService, createAdLibraryService } from './service';
export type {
  AdPlatform,
  AdCreative,
  AdLibraryOptions,
  AdLibraryResponse,
  MultiPlatformAdResponse,
} from './types';
```

**Verification:** Imports work from `@/lib/ad-library`

---

### Task 5: Add basic error handling and rate limiting
**File:** `src/lib/ad-library/service.ts` (update)

Add rate limiting awareness:
- Track last request time per platform
- Add 100ms minimum delay between requests to same platform
- Return graceful error responses (don't throw) for API failures
- Log errors with platform context

**Verification:** Service handles API errors without crashing

## Success Criteria

1. `AdLibraryService` can fetch ads from all 3 platforms
2. Unified `AdCreative` type normalizes different API responses
3. Image URLs are correctly extracted per platform
4. Errors are handled gracefully with informative messages
5. `npm run build` passes with new service

## Files to Create/Modify

| File | Action |
|------|--------|
| `src/lib/ad-library/types.ts` | Create |
| `src/lib/ad-library/service.ts` | Create |
| `src/lib/ad-library/index.ts` | Create |
| `src/lib/env.ts` | Modify (add SEARCHAPI_KEY) |

## Estimated Complexity

- **Types:** Simple - straightforward interface definitions
- **Service:** Medium - API integration with normalization logic
- **Total:** ~200-250 lines of TypeScript

## Notes

- The test script `test-ad-libraries-local.ts` can be deleted after this service is working
- Phase 24 will integrate this service into the competitor research pipeline
- Consider caching ad results per competitor in Phase 24 to reduce API calls
