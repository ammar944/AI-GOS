---
phase: 17-explain-agent
plan: 01
type: execute
---

<objective>
Implement the Explain Agent to provide reasoning explanations and related factors for any blueprint content.

Purpose: Users can ask "why" questions about blueprint recommendations and get contextual explanations that draw on the underlying data and reasoning.
Output: explain-agent.ts with handleExplain() function, integrated into session-based chat API.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

**Prior phase context:**
@.planning/phases/15-rag-foundation/15-03-SUMMARY.md
@.planning/phases/16-edit-capability/16-01-SUMMARY.md

**Existing agent patterns:**
@src/lib/chat/agents/qa-agent.ts
@src/lib/chat/agents/edit-agent.ts
@src/lib/chat/types.ts
@src/lib/chat/intent-router.ts

**Chat API (session-based):**
@src/app/api/chat/blueprint/route.ts

**Prior decisions affecting this phase:**
- Session-based chat (no DB required) - 16-03 decision
- Claude Sonnet for agents (Haiku not available on OpenRouter) - 16-01 decision
- Temperature 0.3 for Q&A, 0.2 for edits - use 0.3 for explain (similar to Q&A)
- Intent router already classifies ExplainIntent but returns placeholder

**What needs implementing:**
1. explain-agent.ts - handles ExplainIntent, provides reasoning about field values
2. Integration with session-based chat API - dispatch explain intents to agent
3. UX polish - explanations should feel conversational, reference related data
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Explain Agent</name>
  <files>src/lib/chat/agents/explain-agent.ts</files>
  <action>
Create explain-agent.ts following the established agent pattern (qa-agent, edit-agent).

Structure:
```typescript
// src/lib/chat/agents/explain-agent.ts
// Explain Agent for providing reasoning explanations about blueprint content

import { createOpenRouterClient, MODELS } from '@/lib/openrouter/client';
import { ExplainIntent, BlueprintSection } from '../types';

export interface ExplainContext {
  /** The full blueprint data for comprehensive context */
  fullBlueprint: Record<string, unknown>;
  /** The classified explain intent */
  intent: ExplainIntent;
  /** Optional chat history */
  chatHistory?: { role: 'user' | 'assistant'; content: string }[];
}

export interface ExplainResponse {
  /** The explanation text */
  explanation: string;
  /** Related factors from other sections */
  relatedFactors: {
    section: BlueprintSection;
    factor: string;
    relevance: string;
  }[];
  /** Confidence in the explanation */
  confidence: 'high' | 'medium' | 'low';
  /** Token usage */
  usage: {
    promptTokens: number;
    completionTokens: number;
    totalTokens: number;
  };
  /** Cost */
  cost: number;
}
```

System prompt should:
- Explain WHY the AI made specific recommendations (positioning, scores, etc.)
- Draw connections between sections (how ICP analysis influenced messaging angles)
- Reference specific data points as evidence
- Identify related factors from other sections that contributed to the recommendation
- Be conversational and educational, not just data dump

Response structure:
- Direct explanation answering the "why" question
- Supporting evidence from the blueprint
- Related factors from other sections (if applicable)
- Confidence level based on data availability

Temperature: 0.3 (same as Q&A - want consistent, informative responses)
maxTokens: 1536 (explanations need more space than Q&A)
  </action>
  <verify>npx tsc --noEmit passes, explain-agent.ts exports handleExplain function</verify>
  <done>explain-agent.ts exists with ExplainContext, ExplainResponse interfaces and handleExplain() function</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Explain Agent into Session Chat API</name>
  <files>src/app/api/chat/blueprint/route.ts</files>
  <action>
Update the session-based chat API to detect explain requests and route to the explain agent.

The current API handles Q&A and edits in a single prompt. For explains:
1. Detect explain intent patterns (keywords: "why", "explain", "reasoning", "how come")
2. Route to explain agent when pattern detected
3. Format explain response with related factors

Detection approach (add to SYSTEM_PROMPT):
```
FOR EXPLANATIONS (user asks "why" something is a certain way):
- Explain the reasoning behind the recommendation or assessment
- Reference specific data that informed the decision
- Connect related factors from other sections
- Respond with a JSON block:

\`\`\`json
{
  "isExplanation": true,
  "explanation": "The reasoning explanation...",
  "relatedFactors": [
    {"section": "sectionName", "factor": "what contributed", "relevance": "how it connects"}
  ]
}
\`\`\`
```

Add extractExplanation() helper similar to extractEdits():
- Parse JSON block from response
- Return { text, explanation, relatedFactors } or { text, explanation: null }

Update response formatting:
- If explanation detected, format with "Related Factors" section
- Include confidence based on how much supporting data was referenced

Keep the existing Q&A and edit handling intact - this adds explain as a third capability.
  </action>
  <verify>npx tsc --noEmit passes, API handles explain patterns correctly</verify>
  <done>Chat API detects explain patterns, routes appropriately, and formats responses with related factors</done>
</task>

<task type="auto">
  <name>Task 3: Polish Chat Response Formatting</name>
  <files>src/components/chat/chat-message.tsx</files>
  <action>
Enhance ChatMessage component to render explanations with better formatting:

1. Detect explanation responses (presence of "Related Factors" section or explanation markers)
2. Style related factors as a collapsible or highlighted section
3. Add visual distinction for different response types:
   - Q&A: Standard text with confidence badge
   - Edit: Diff preview with confirm/cancel (already exists)
   - Explain: Explanation text + related factors in a styled card

Add styling for related factors:
```tsx
{relatedFactors && (
  <div className="mt-3 pt-3 border-t border-muted">
    <div className="text-xs font-medium text-muted-foreground mb-2">
      Related Factors
    </div>
    <div className="space-y-2">
      {relatedFactors.map((factor, i) => (
        <div key={i} className="text-sm">
          <span className="font-medium">{sectionLabel(factor.section)}:</span>{' '}
          <span>{factor.factor}</span>
          <span className="text-muted-foreground"> â€” {factor.relevance}</span>
        </div>
      ))}
    </div>
  </div>
)}
```

Keep changes minimal - enhance existing ChatMessage rather than creating new component.
  </action>
  <verify>npm run build succeeds, chat messages render explanations with related factors styling</verify>
  <done>ChatMessage renders explanation responses with related factors section styled distinctly</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] explain-agent.ts exports handleExplain function
- [ ] Chat API handles explain-type questions (test: "Why is the positioning focused on X?")
- [ ] Related factors display correctly in chat UI
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Users can ask "why" questions and get contextual explanations
- Explanations reference supporting data and related factors
- No TypeScript errors or build failures
</success_criteria>

<output>
After completion, create `.planning/phases/17-explain-agent/17-01-SUMMARY.md`:

# Phase 17 Plan 01: Explain Agent Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 17 complete, ready for v1.4 milestone completion
</output>
