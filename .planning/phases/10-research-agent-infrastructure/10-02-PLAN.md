---
phase: 10-research-agent-infrastructure
plan: 2
type: execute
---

<objective>
Create ResearchAgent abstraction that wraps OpenRouter client with research-specific features: citation extraction, cost tracking, and multi-step pipeline support.

Purpose: Provide a clean abstraction for research operations that automatically handles citations, allowing section generators to focus on prompts rather than API mechanics.
Output: ResearchAgent class in src/lib/research/agent.ts with citation-aware chat methods and research cost tracking.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-research-agent-infrastructure/DISCOVERY.md
@.planning/phases/10-research-agent-infrastructure/10-01-SUMMARY.md

**Prior decisions affecting this phase:**
- Phase 9: Model capability helpers (supportsReasoning, hasWebSearch)
- Plan 10-01: Citation types and extractCitations() helper added

**Codebase constraints:**
- Follow existing service patterns (see strategic-blueprint-generator.ts)
- Use existing OpenRouter client - don't duplicate functionality
- Export from index for clean imports

@src/lib/openrouter/client.ts
@src/lib/strategic-blueprint/output-types.ts
@src/lib/strategic-blueprint/pipeline/strategic-blueprint-generator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create research agent types</name>
  <files>src/lib/research/types.ts</files>
  <action>
Create new file src/lib/research/types.ts with research-specific types:

```typescript
// Research Agent Types
// Types for research operations with citation tracking

import type { ChatMessage, ReasoningOptions } from "@/lib/openrouter/client";
import type { Citation } from "@/lib/strategic-blueprint/output-types";

/** Research request options */
export interface ResearchOptions {
  /** The model to use for research */
  model: string;
  /** Chat messages (system + user prompts) */
  messages: ChatMessage[];
  /** Temperature for response generation */
  temperature?: number;
  /** Maximum tokens for response */
  maxTokens?: number;
  /** Enable JSON mode for structured output */
  jsonMode?: boolean;
  /** Request timeout in ms */
  timeout?: number;
  /** Reasoning options for supported models */
  reasoning?: ReasoningOptions;
}

/** Research response with citations */
export interface ResearchResponse<T = string> {
  /** The research content (string or parsed JSON) */
  content: T;
  /** Citations extracted from the response */
  citations: Citation[];
  /** Token usage */
  usage: {
    promptTokens: number;
    completionTokens: number;
    totalTokens: number;
  };
  /** Cost breakdown */
  cost: {
    /** Base API cost (input + output tokens) */
    apiCost: number;
    /** Estimated citation token cost (Perplexity only) */
    citationCost: number;
    /** Total cost */
    totalCost: number;
  };
  /** Model used */
  model: string;
}

/** Research cost tracking for a session/pipeline */
export interface ResearchCostSummary {
  /** Total API costs across all calls */
  totalApiCost: number;
  /** Total estimated citation costs */
  totalCitationCost: number;
  /** Total combined cost */
  totalCost: number;
  /** Number of research calls made */
  callCount: number;
  /** Total citations collected */
  citationCount: number;
  /** Breakdown by model */
  byModel: Record<string, { calls: number; cost: number; citations: number }>;
}
```
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>Research types exported from src/lib/research/types.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create ResearchAgent class</name>
  <files>src/lib/research/agent.ts</files>
  <action>
Create new file src/lib/research/agent.ts:

```typescript
// Research Agent
// Wraps OpenRouter client with citation extraction and research-specific features

import { z } from "zod";
import {
  OpenRouterClient,
  createOpenRouterClient,
  MODELS,
  extractCitations,
  hasWebSearch,
  type ChatMessage,
} from "@/lib/openrouter/client";
import type { Citation } from "@/lib/strategic-blueprint/output-types";
import type {
  ResearchOptions,
  ResearchResponse,
  ResearchCostSummary,
} from "./types";

// Estimated cost per 1M citation tokens (Perplexity Deep Research)
const CITATION_TOKEN_COST_PER_MILLION = 2.0;
// Estimated average citation tokens per web search call
const ESTIMATED_CITATION_TOKENS_PER_CALL = 5000;

/**
 * Research agent that wraps OpenRouter client with citation extraction
 * and research-specific cost tracking.
 */
export class ResearchAgent {
  private client: OpenRouterClient;
  private costSummary: ResearchCostSummary;

  constructor(client?: OpenRouterClient) {
    this.client = client ?? createOpenRouterClient();
    this.costSummary = this.initCostSummary();
  }

  private initCostSummary(): ResearchCostSummary {
    return {
      totalApiCost: 0,
      totalCitationCost: 0,
      totalCost: 0,
      callCount: 0,
      citationCount: 0,
      byModel: {},
    };
  }

  /**
   * Perform a research query and extract citations.
   * Use this for free-form research where you want the raw content.
   */
  async research(options: ResearchOptions): Promise<ResearchResponse<string>> {
    const response = await this.client.chat({
      model: options.model,
      messages: options.messages,
      temperature: options.temperature ?? 0.3,
      maxTokens: options.maxTokens ?? 4096,
      jsonMode: options.jsonMode,
      timeout: options.timeout,
      reasoning: options.reasoning,
    });

    const citations = extractCitations(response);
    const cost = this.calculateCost(options.model, response.cost, citations.length);

    this.updateCostSummary(options.model, cost, citations.length);

    return {
      content: response.content,
      citations,
      usage: response.usage,
      cost,
      model: options.model,
    };
  }

  /**
   * Perform research and parse the JSON response with Zod validation.
   * Includes retries for validation failures.
   */
  async researchJSON<T>(
    options: ResearchOptions,
    schema: z.ZodType<T>,
    retries: number = 2
  ): Promise<ResearchResponse<T>> {
    const response = await this.client.chatJSONValidated(
      {
        model: options.model,
        messages: options.messages,
        temperature: options.temperature ?? 0.3,
        maxTokens: options.maxTokens ?? 4096,
        jsonMode: true,
        timeout: options.timeout,
        reasoning: options.reasoning,
      },
      schema,
      retries
    );

    // Note: chatJSONValidated doesn't return citations directly
    // We need to make a separate call or use chat() for citation-critical research
    // For now, return empty citations for JSON-validated calls
    // Future: extend chatJSONValidated to preserve citations
    const citations: Citation[] = [];
    const cost = this.calculateCost(options.model, response.cost, citations.length);

    this.updateCostSummary(options.model, cost, citations.length);

    return {
      content: response.data,
      citations,
      usage: response.usage,
      cost,
      model: options.model,
    };
  }

  /**
   * Get the accumulated cost summary for this agent instance.
   */
  getCostSummary(): ResearchCostSummary {
    return { ...this.costSummary };
  }

  /**
   * Reset the cost tracking for a new research session.
   */
  resetCostTracking(): void {
    this.costSummary = this.initCostSummary();
  }

  private calculateCost(
    model: string,
    apiCost: number,
    citationCount: number
  ): ResearchResponse["cost"] {
    // Only estimate citation costs for web search models
    const citationCost = hasWebSearch(model)
      ? (ESTIMATED_CITATION_TOKENS_PER_CALL * citationCount / 1_000_000) * CITATION_TOKEN_COST_PER_MILLION
      : 0;

    return {
      apiCost,
      citationCost,
      totalCost: apiCost + citationCost,
    };
  }

  private updateCostSummary(
    model: string,
    cost: ResearchResponse["cost"],
    citationCount: number
  ): void {
    this.costSummary.totalApiCost += cost.apiCost;
    this.costSummary.totalCitationCost += cost.citationCost;
    this.costSummary.totalCost += cost.totalCost;
    this.costSummary.callCount += 1;
    this.costSummary.citationCount += citationCount;

    if (!this.costSummary.byModel[model]) {
      this.costSummary.byModel[model] = { calls: 0, cost: 0, citations: 0 };
    }
    this.costSummary.byModel[model].calls += 1;
    this.costSummary.byModel[model].cost += cost.totalCost;
    this.costSummary.byModel[model].citations += citationCount;
  }
}

/**
 * Factory function to create a research agent.
 */
export function createResearchAgent(): ResearchAgent {
  return new ResearchAgent();
}
```

Key design decisions:
- Wraps existing OpenRouter client (no duplication)
- Tracks costs per-call and accumulated
- Estimates citation costs for web search models
- Provides both raw research() and validated researchJSON() methods
- Cost summary can be reset for new pipelines
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>ResearchAgent class with citation extraction and cost tracking</done>
</task>

<task type="auto">
  <name>Task 3: Create research module index</name>
  <files>src/lib/research/index.ts</files>
  <action>
Create barrel export file src/lib/research/index.ts:

```typescript
// Research Module
// Exports for research agent functionality

export { ResearchAgent, createResearchAgent } from "./agent";
export type {
  ResearchOptions,
  ResearchResponse,
  ResearchCostSummary,
} from "./types";
```

This provides clean imports:
```typescript
import { createResearchAgent, type ResearchResponse } from "@/lib/research";
```
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>Research module exports consolidated in index.ts</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes without errors
- [ ] src/lib/research/types.ts created with ResearchOptions, ResearchResponse, ResearchCostSummary
- [ ] src/lib/research/agent.ts created with ResearchAgent class
- [ ] src/lib/research/index.ts exports all types and createResearchAgent factory
- [ ] ResearchAgent.research() returns content + citations
- [ ] ResearchAgent.researchJSON() returns validated content
- [ ] Cost tracking accumulates across multiple calls
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- ResearchAgent can be instantiated and used for research queries
- Citation extraction works for Perplexity models
- Cost tracking provides breakdown by model
- Phase 10 complete, ready for Phase 11 (Section 4 Competitor Analysis Enhancement)
</success_criteria>

<output>
After completion, create `.planning/phases/10-research-agent-infrastructure/10-02-SUMMARY.md`:

# Phase 10 Plan 2: Research Agent Abstraction Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 10 complete, ready for Phase 11 (Section 4 Competitor Analysis Enhancement)
</output>
