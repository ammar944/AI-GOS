---
phase: 10-research-agent-infrastructure
plan: 1
type: execute
---

<objective>
Add citation types and extend OpenRouter client to handle Perplexity research responses with citations.

Purpose: Enable citation extraction from Perplexity research models, providing the foundation for cited strategic research.
Output: Citation types in output-types.ts, extended OpenRouter response types with citation extraction helper.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-research-agent-infrastructure/DISCOVERY.md

**Prior decisions affecting this phase:**
- Phase 9: Set<string> for model capability sets (TypeScript compatibility)
- Phase 9: supportsReasoning() and hasWebSearch() helpers available

**Codebase constraints:**
- Follow existing type patterns in src/lib/strategic-blueprint/output-types.ts
- Extend existing OpenRouter client without breaking current usage
- Use Zod for runtime validation where needed

@src/lib/openrouter/client.ts
@src/lib/strategic-blueprint/output-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Citation and SearchResult types</name>
  <files>src/lib/strategic-blueprint/output-types.ts</files>
  <action>
Add Citation-related types at the end of the file (before the section order constants):

```typescript
// =============================================================================
// Citation Types (for research agent responses)
// =============================================================================

/** A citation from a research model response */
export interface Citation {
  /** Source URL */
  url: string;
  /** Source title (from search_results) */
  title?: string;
  /** Publication/last updated date */
  date?: string;
  /** Brief excerpt from the source */
  snippet?: string;
}

/** Section output with citations */
export interface CitedSectionOutput<T> {
  /** The section data */
  data: T;
  /** Citations used to generate this section */
  citations: Citation[];
  /** Model that generated this section */
  model: string;
  /** Cost of this section's generation */
  cost: number;
}
```

This creates a unified Citation type that supports both the legacy `citations` array (URLs only) and the new `search_results` format (with title, date, snippet).
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>Citation and CitedSectionOutput types exported from output-types.ts</done>
</task>

<task type="auto">
  <name>Task 2: Extend OpenRouter client response types</name>
  <files>src/lib/openrouter/client.ts</files>
  <action>
1. Add new interfaces for Perplexity response fields after ChatCompletionResponse interface:

```typescript
/** Search result from Perplexity API (structured citation) */
export interface PerplexitySearchResult {
  title: string;
  url: string;
  date?: string;
  snippet?: string;
}

/** Extended response with Perplexity citation fields */
export interface ChatCompletionResponseWithCitations extends ChatCompletionResponse {
  /** Legacy citation URLs (being deprecated by Perplexity) */
  citations?: string[];
  /** Structured search results (preferred format as of May 2025) */
  searchResults?: PerplexitySearchResult[];
}
```

2. Update the chat() method to extract and return citation fields:
   - After parsing `const data = await response.json();`
   - Before the return statement, extract citations:

```typescript
    // Extract Perplexity citation fields if present
    const citations = data.citations as string[] | undefined;
    const searchResults = data.search_results as PerplexitySearchResult[] | undefined;

    return {
      content: data.choices[0]?.message?.content || "",
      usage: {
        promptTokens,
        completionTokens,
        totalTokens: promptTokens + completionTokens,
      },
      cost: estimateCost(model, promptTokens, completionTokens),
      // Include citation fields (only present for Perplexity models)
      ...(citations && { citations }),
      ...(searchResults && { searchResults }),
    };
```

3. Update the ChatCompletionResponse interface to include optional citation fields:

```typescript
export interface ChatCompletionResponse {
  content: string;
  usage: {
    promptTokens: number;
    completionTokens: number;
    totalTokens: number;
  };
  cost: number;
  /** Citation URLs from Perplexity (legacy format) */
  citations?: string[];
  /** Structured search results from Perplexity (new format) */
  searchResults?: PerplexitySearchResult[];
}
```

Note: The PerplexitySearchResult interface uses camelCase while the API returns snake_case - the chat() method handles the conversion.
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>ChatCompletionResponse includes optional citations and searchResults fields, chat() method extracts these from Perplexity responses</done>
</task>

<task type="auto">
  <name>Task 3: Add citation extraction helper</name>
  <files>src/lib/openrouter/client.ts</files>
  <action>
Add a helper function after the hasWebSearch() function:

```typescript
/**
 * Extract normalized citations from an OpenRouter response.
 * Prefers structured search_results over legacy citations array.
 * Returns empty array for non-research models.
 */
export function extractCitations(response: ChatCompletionResponse): Citation[] {
  // Import Citation type at top of file:
  // import type { Citation } from "@/lib/strategic-blueprint/output-types";

  // Prefer structured searchResults (new format as of May 2025)
  if (response.searchResults?.length) {
    return response.searchResults.map(sr => ({
      url: sr.url,
      title: sr.title,
      date: sr.date,
      snippet: sr.snippet,
    }));
  }

  // Fallback to legacy citations array (URLs only)
  if (response.citations?.length) {
    return response.citations.map(url => ({ url }));
  }

  return [];
}
```

Add the import at the top of the file with other imports:
```typescript
import type { Citation } from "@/lib/strategic-blueprint/output-types";
```

This helper:
- Returns Citation[] with full metadata when available (searchResults)
- Falls back to URL-only citations for legacy responses
- Returns empty array for non-research model responses
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>extractCitations() helper exported from client.ts, properly typed with Citation import</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes without errors
- [ ] Citation and CitedSectionOutput types exported from output-types.ts
- [ ] ChatCompletionResponse includes citations and searchResults fields
- [ ] extractCitations() helper returns Citation[] from either format
- [ ] No breaking changes to existing code (chatJSON, chatJSONValidated still work)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Existing strategic blueprint generation still works (no breaking changes)
- Citation types ready for use in research agent
</success_criteria>

<output>
After completion, create `.planning/phases/10-research-agent-infrastructure/10-01-SUMMARY.md`:

# Phase 10 Plan 1: Citation Types & OpenRouter Extension Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 10-02-PLAN.md (Research Agent Abstraction)
</output>
