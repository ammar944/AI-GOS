---
phase: 24-competitor-ad-research
plan: 01
type: execute
---

<objective>
Integrate AdLibraryService into the Section 4 competitor research pipeline to fetch real ad creatives for each competitor.

Purpose: Enrich competitor snapshots with actual ad data from LinkedIn, Meta, and Google ad libraries.
Output: Updated competitor-research.ts that fetches and attaches real ad creatives per competitor.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior decisions affecting this phase:**
- Phase 23: AdLibraryService created with fetchAllPlatforms(), per-platform fetch methods, and rate limiting
- Phase 23: extractDomain() helper converts company names to domains for Google Ads queries
- Phase 11: competitor-research.ts uses research() for citations, manual JSON parsing

**Phase 23 Summary (dependency):**
- AdLibraryService available via `createAdLibraryService()` from `@/lib/ad-library`
- Types: AdCreative, AdLibraryOptions, MultiPlatformAdResponse
- Service handles rate limiting (100ms between same-platform requests)
- Graceful error handling (returns error response, doesn't throw)

**Key source files:**
@src/lib/ad-library/service.ts
@src/lib/ad-library/types.ts
@src/lib/strategic-blueprint/pipeline/competitor-research.ts
@src/lib/strategic-blueprint/output-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add adCreatives field to CompetitorSnapshot type</name>
  <files>src/lib/strategic-blueprint/output-types.ts</files>
  <action>
Add optional adCreatives array to CompetitorSnapshot interface:

1. Import AdCreative type from ad-library:
   ```typescript
   import type { AdCreative } from '@/lib/ad-library';
   ```

2. Add field to CompetitorSnapshot interface (after weaknesses):
   ```typescript
   /** Real ad creatives fetched from ad libraries */
   adCreatives?: AdCreative[];
   ```

This keeps the field optional so existing code continues to work during rollout.
  </action>
  <verify>npm run build passes with no TypeScript errors</verify>
  <done>CompetitorSnapshot interface includes optional adCreatives: AdCreative[] field</done>
</task>

<task type="auto">
  <name>Task 2: Fetch ads for competitors in researchCompetitors function</name>
  <files>src/lib/strategic-blueprint/pipeline/competitor-research.ts</files>
  <action>
Modify researchCompetitors() to fetch real ads after getting competitor names from Perplexity:

1. Import AdLibraryService:
   ```typescript
   import { createAdLibraryService } from '@/lib/ad-library';
   import type { AdCreative } from '@/lib/ad-library';
   ```

2. After parsing competitor analysis JSON (after line ~103), fetch ads for each competitor:
   ```typescript
   // Fetch real ads for each competitor
   const adService = createAdLibraryService();
   const competitorAds = await fetchCompetitorAds(adService, data.competitors);

   // Merge ads into competitor snapshots
   data.competitors = mergeAdsIntoCompetitors(data.competitors, competitorAds);
   ```

3. Add helper function fetchCompetitorAds():
   ```typescript
   async function fetchCompetitorAds(
     adService: AdLibraryService,
     competitors: CompetitorSnapshot[]
   ): Promise<Map<string, AdCreative[]>> {
     const adsMap = new Map<string, AdCreative[]>();

     // Fetch ads for each competitor in parallel (service handles rate limiting)
     const fetchPromises = competitors.map(async (competitor) => {
       try {
         const response = await adService.fetchAllPlatforms({
           query: competitor.name,
           limit: 10, // 10 ads per platform max
         });

         // Combine all successful platform results
         const allAds = response.results
           .filter(r => r.success)
           .flatMap(r => r.ads);

         adsMap.set(competitor.name, allAds);
       } catch (error) {
         console.error(`[Competitor Research] Failed to fetch ads for ${competitor.name}:`, error);
         adsMap.set(competitor.name, []);
       }
     });

     await Promise.all(fetchPromises);
     return adsMap;
   }
   ```

4. Add helper function mergeAdsIntoCompetitors():
   ```typescript
   function mergeAdsIntoCompetitors(
     competitors: CompetitorSnapshot[],
     adsMap: Map<string, AdCreative[]>
   ): CompetitorSnapshot[] {
     return competitors.map(competitor => ({
       ...competitor,
       adCreatives: adsMap.get(competitor.name) || [],
     }));
   }
   ```

Important: The AdLibraryService constructor calls getRequiredEnv('SEARCHAPI_KEY'), so if the key is missing, it will throw. Wrap the ad fetching in a try-catch so missing API key doesn't break competitor research entirely.
  </action>
  <verify>npm run build passes, no TypeScript errors in competitor-research.ts</verify>
  <done>researchCompetitors() fetches real ads from all 3 platforms for each competitor and attaches to CompetitorSnapshot</done>
</task>

<task type="auto">
  <name>Task 3: Add graceful degradation and cost tracking for ad fetches</name>
  <files>src/lib/strategic-blueprint/pipeline/competitor-research.ts</files>
  <action>
Update the implementation to handle missing SEARCHAPI_KEY gracefully and track timing:

1. Wrap ad fetching in try-catch to handle missing API key:
   ```typescript
   // Fetch real ads for each competitor (graceful degradation if API key missing)
   let competitorAds = new Map<string, AdCreative[]>();
   try {
     const adService = createAdLibraryService();
     competitorAds = await fetchCompetitorAds(adService, data.competitors);
     console.log(`[Competitor Research] Fetched ads for ${competitorAds.size} competitors`);
   } catch (error) {
     // SEARCHAPI_KEY missing or service creation failed - continue without ads
     console.warn('[Competitor Research] Ad library unavailable, continuing without ads:',
       error instanceof Error ? error.message : 'Unknown error');
   }
   ```

2. Log summary of ads fetched:
   ```typescript
   // After merging, log summary
   const totalAds = data.competitors.reduce((sum, c) => sum + (c.adCreatives?.length || 0), 0);
   if (totalAds > 0) {
     console.log(`[Competitor Research] Total ads attached: ${totalAds} across ${data.competitors.length} competitors`);
   }
   ```

3. Update the return statement to include ad fetch info in a comment (cost is $0 for SearchAPI.io with existing plan):
   ```typescript
   return {
     data,
     citations: response.citations,
     model: response.model,
     cost: response.cost.totalCost, // Ad library calls have no additional cost
   };
   ```

The SearchAPI.io calls don't have per-call costs (included in subscription), so we don't need to track additional cost. The existing cost tracking for the Perplexity research call remains accurate.
  </action>
  <verify>
1. npm run build passes
2. If SEARCHAPI_KEY is missing, competitor research still works (returns competitors without adCreatives)
3. If SEARCHAPI_KEY is present, competitors have adCreatives arrays populated
  </verify>
  <done>
- Competitor research degrades gracefully if SEARCHAPI_KEY is missing
- Ad fetches logged for debugging
- Competitors have adCreatives populated when API available
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] CompetitorSnapshot type includes adCreatives field
- [ ] researchCompetitors() fetches ads when SEARCHAPI_KEY is available
- [ ] researchCompetitors() works without crashing when SEARCHAPI_KEY is missing
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Competitor research pipeline integrates ad fetching
- Graceful degradation when ad library unavailable
</success_criteria>

<output>
After completion, create `.planning/phases/24-competitor-ad-research/24-01-SUMMARY.md`:

# Phase 24 Plan 01: Competitor Ad Research Integration Summary

**[Substantive one-liner about what shipped]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
Phase complete, ready for Phase 25 (Creative Carousel UI)
</output>
