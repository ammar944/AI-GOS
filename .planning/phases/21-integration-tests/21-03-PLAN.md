---
phase: 21-integration-tests
plan: 03
type: execute
---

<objective>
Integration tests for RAG services including retrieval, intent classification, and chat agents with mocked embeddings and database operations.

Purpose: Verify the chat/RAG system correctly retrieves context, classifies intents, and generates appropriate responses.
Output: Integration tests for retrieval service, intent router, and chat agents with ~30-35 tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior plans in this phase:**
@.planning/phases/21-integration-tests/21-01-SUMMARY.md
@.planning/phases/21-integration-tests/21-02-SUMMARY.md

**Codebase constraints:**
- MockSupabaseClient for database mocking (from Phase 19)
- MockOpenRouterClient for AI and embedding mocking
- Supabase RPC functions for vector search

**Source files:**
@src/lib/chat/retrieval.ts
@src/lib/chat/embeddings.ts
@src/lib/chat/intent-router.ts
@src/lib/chat/agents/qa-agent.ts
@src/lib/chat/agents/edit-agent.ts
@src/lib/chat/agents/explain-agent.ts
@src/test/mocks/supabase.ts
@src/test/mocks/openrouter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Retrieval service integration tests</name>
  <files>src/lib/chat/__tests__/retrieval.integration.test.ts</files>
  <action>
Create integration tests for retrieveRelevantChunks():

**Happy path tests:**
- Returns chunks from mocked Supabase RPC (match_blueprint_chunks)
- Chunks are correctly mapped from snake_case to camelCase
- Includes similarity scores in results
- Respects matchThreshold parameter
- Respects matchCount parameter
- Filters by section when sectionFilter provided

**Context building tests (buildContextFromChunks):**
- Builds formatted context string from chunks
- Includes relevance percentage in context
- Returns "No relevant context" for empty chunks
- Handles chunks without similarity scores

**Error tests:**
- Throws meaningful error when RPC fails
- Handles empty results gracefully

Mock strategy:
- vi.mock('@/lib/supabase/server') to return MockSupabaseClient
- vi.mock('./embeddings') to mock generateEmbedding
- Queue RPC responses with createMockBlueprintChunk factory
  </action>
  <verify>npm test src/lib/chat/__tests__/retrieval.integration.test.ts passes</verify>
  <done>~12 tests covering retrieval, context building, and error scenarios</done>
</task>

<task type="auto">
  <name>Task 2: Intent router integration tests</name>
  <files>src/lib/chat/__tests__/intent-router.integration.test.ts</files>
  <action>
Create integration tests for classifyIntent():

**Intent classification tests:**
- Classifies "What are the main competitors?" as question intent
- Classifies "Change the budget to $5000" as edit intent
- Classifies "Why did you recommend Facebook ads?" as explain intent
- Classifies "Regenerate the competitor analysis" as regenerate intent
- Classifies "Hello" as general intent
- Returns correct sections array for question intents
- Returns correct section for edit/explain intents
- Includes desiredChange for edit intents
- Includes whatToExplain for explain intents

**Validation tests:**
- Validates section names against allowed list
- Defaults to crossAnalysisSynthesis for invalid sections
- Handles malformed JSON response gracefully

**Cost tracking tests:**
- Returns usage stats from classification
- Returns cost estimate

Mock strategy:
- Mock OpenRouterClient.chat() to return classification JSON
- Use createMockJSONResponse for different intent types
- Test each intent type with realistic user messages
  </action>
  <verify>npm test src/lib/chat/__tests__/intent-router.integration.test.ts passes</verify>
  <done>~12 tests covering all intent types, validation, and cost tracking</done>
</task>

<task type="auto">
  <name>Task 3: Chat agents integration tests</name>
  <files>src/lib/chat/agents/__tests__/agents.integration.test.ts</files>
  <action>
Create integration tests for all three chat agents:

**Q&A Agent tests:**
- Generates answer using retrieved context
- Includes source references in response
- Handles empty context gracefully
- Respects chat history for context

**Edit Agent tests:**
- Identifies correct field path for edit
- Returns structured edit proposal
- Validates edit against blueprint schema
- Handles ambiguous edit requests

**Explain Agent tests:**
- Generates explanation for specified field
- Includes reasoning and related factors
- References blueprint data in explanation
- Handles missing field gracefully

**Common tests for all agents:**
- Returns usage and cost metrics
- Handles AI errors gracefully
- Works with provided blueprint context

Mock strategy:
- Mock retrieval service to return test chunks
- Mock OpenRouterClient for agent responses
- Use factories for blueprint test data

Test structure:
- describe('QAAgent')
- describe('EditAgent')
- describe('ExplainAgent')
  </action>
  <verify>npm test src/lib/chat/agents/__tests__/agents.integration.test.ts passes</verify>
  <done>~12 tests covering Q&A, Edit, and Explain agents</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- --run` passes all tests (no regressions)
- [ ] Retrieval service tests verify vector search integration
- [ ] Intent router tests cover all intent types
- [ ] Agent tests verify response generation
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- ~30-35 new RAG integration tests
- Phase 21 complete: All 3 plans finished
- Total integration tests for phase: ~80-95 tests
</success_criteria>

<output>
After completion, create `.planning/phases/21-integration-tests/21-03-SUMMARY.md`

Include in summary:
- Total integration test count for Phase 21
- Coverage areas (pipeline, API routes, RAG)
- Any patterns established for future integration tests
</output>
