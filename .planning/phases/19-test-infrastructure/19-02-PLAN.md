---
phase: 19-test-infrastructure
plan: 02
type: execute
---

<objective>
Create sample unit tests to validate the test infrastructure works correctly.

Purpose: Verify test setup by writing real tests for utility modules, demonstrating patterns for future test development.
Output: Working unit tests for core utilities (env.ts, errors.ts, circuit-breaker.ts) proving the test infrastructure is functional.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-test-infrastructure/19-01-SUMMARY.md

**Files to test:**
@src/lib/env.ts - Environment variable validation (validateEnv, getEnv, getRequiredEnv, hasEnv)
@src/lib/errors.ts - Error handling utilities (createErrorResponse, mapFailureReasonToCode, getHttpStatusForCode)
@src/lib/openrouter/circuit-breaker.ts - Circuit breaker pattern (CLOSED/OPEN/HALF_OPEN states)

**Test infrastructure from 19-01:**
- Vitest configured with jsdom environment
- Mock clients for OpenRouter and Supabase
- Test utilities in src/test/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for env.ts</name>
  <files>src/lib/__tests__/env.test.ts</files>
  <action>
    1. Create src/lib/__tests__/env.test.ts with tests for:

    validateEnv():
    - Returns { valid: true, missing: [] } when all required vars present
    - Returns { valid: false, missing: [...] } listing missing vars
    - Test with mocked process.env

    getEnv(name):
    - Returns undefined for missing vars
    - Returns value for present vars
    - Handles empty string values

    getRequiredEnv(name):
    - Throws when var missing
    - Returns value when present
    - Error message includes var name

    hasEnv(name):
    - Returns false for missing vars
    - Returns true for present vars
    - Returns true for empty string (var exists but empty)

    2. Use vi.stubEnv() or manual process.env manipulation with cleanup
    3. Follow AAA pattern (Arrange, Act, Assert)
    4. Group tests with describe() blocks per function
  </action>
  <verify>npm run test:run src/lib/__tests__/env.test.ts passes</verify>
  <done>All env.ts functions have unit tests, 100% of public API tested</done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for errors.ts</name>
  <files>src/lib/__tests__/errors.test.ts</files>
  <action>
    1. Create src/lib/__tests__/errors.test.ts with tests for:

    ErrorCode enum:
    - Verify all error codes exist (VALIDATION_ERROR, TIMEOUT, etc.)
    - Test code values are as expected

    createErrorResponse(code, message, details?):
    - Returns correct structure { error: { code, message, details? } }
    - Handles optional details parameter
    - Preserves error code enum value

    mapFailureReasonToCode(reason):
    - Maps "timeout" to TIMEOUT
    - Maps "rate_limited" to RATE_LIMITED
    - Maps "parse_failed" to PARSE_ERROR
    - Maps unknown reasons to INTERNAL_ERROR

    getHttpStatusForCode(code):
    - VALIDATION_ERROR -> 400
    - API_ERROR -> 502
    - TIMEOUT -> 504
    - RATE_LIMITED -> 429
    - CIRCUIT_OPEN -> 503
    - INTERNAL_ERROR -> 500
    - Unknown codes -> 500

    2. Use parameterized tests (it.each) for mapping functions
    3. Verify return types match expected TypeScript interfaces
  </action>
  <verify>npm run test:run src/lib/__tests__/errors.test.ts passes</verify>
  <done>All errors.ts functions tested with edge cases covered</done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for circuit-breaker.ts</name>
  <files>src/lib/openrouter/__tests__/circuit-breaker.test.ts</files>
  <action>
    1. Create src/lib/openrouter/__tests__/circuit-breaker.test.ts with tests for:

    CircuitBreaker class initialization:
    - Starts in CLOSED state
    - Accepts custom failureThreshold and resetTimeout

    recordSuccess():
    - Resets failure count to 0
    - Keeps state CLOSED

    recordFailure():
    - Increments failure count
    - Opens circuit when threshold reached
    - Records timestamp when opening

    isOpen():
    - Returns false when CLOSED
    - Returns true when OPEN
    - Returns false when HALF_OPEN (allows retry)

    State transitions:
    - CLOSED -> OPEN after failureThreshold failures
    - OPEN -> HALF_OPEN after resetTimeout elapsed
    - HALF_OPEN -> CLOSED on success
    - HALF_OPEN -> OPEN on failure

    2. Use vi.useFakeTimers() for timeout testing
    3. Test with custom thresholds (not just defaults)
    4. Verify getState() returns correct CircuitState
  </action>
  <verify>npm run test:run src/lib/openrouter/__tests__/circuit-breaker.test.ts passes</verify>
  <done>Circuit breaker state machine fully tested with timer mocking</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Test infrastructure with sample unit tests for core utilities</what-built>
  <how-to-verify>
    1. Run: npm run test:run
    2. Verify all tests pass (should see 3 test files, multiple tests each)
    3. Run: npm run test:coverage (if configured)
    4. Check coverage report shows env.ts, errors.ts, circuit-breaker.ts covered
    5. Optionally run: npm test (watch mode) to see interactive test runner
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any test failures to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all tests
- [ ] All 3 test files exist and run
- [ ] Tests cover core functionality of each module
- [ ] No flaky tests (run twice to confirm)
</verification>

<success_criteria>
- env.ts has comprehensive unit tests
- errors.ts has unit tests for all public functions
- circuit-breaker.ts has state machine tests with timer mocking
- All tests pass consistently
- Test patterns established for future test development
</success_criteria>

<output>
After completion, create `.planning/phases/19-test-infrastructure/19-02-SUMMARY.md`:

# Phase 19 Plan 02: Validation Tests Summary

**[One-liner summarizing test coverage achieved]**

## Accomplishments
- [List key test files and coverage]

## Files Created/Modified
- `src/lib/__tests__/env.test.ts` - Environment utilities tests
- `src/lib/__tests__/errors.test.ts` - Error handling tests
- `src/lib/openrouter/__tests__/circuit-breaker.test.ts` - Circuit breaker tests

## Decisions Made
[Test patterns, naming conventions, etc.]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Phase 19 complete, ready for Phase 20: Unit Tests Core
</output>
