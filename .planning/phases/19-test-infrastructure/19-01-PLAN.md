---
phase: 19-test-infrastructure
plan: 01
type: execute
---

<objective>
Set up Vitest test framework with mocks for OpenRouter and Supabase.

Purpose: Establish test infrastructure that enables unit and integration testing across the codebase.
Output: Configured Vitest, mock clients for external dependencies, reusable test utilities.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files to mock:**
@src/lib/openrouter/client.ts - OpenRouterClient with chat, chatJSON, embeddings methods
@src/lib/supabase/client.ts - Supabase browser client
@src/lib/supabase/server.ts - Supabase server client

**Prior decisions:**
- Next.js 16 + React 19 + TypeScript stack
- OpenRouter for AI model access (Perplexity, Claude, GPT-4o, Gemini)
- Supabase for auth and database (pgvector for embeddings)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Vitest for Next.js</name>
  <files>package.json, vitest.config.ts, tsconfig.json</files>
  <action>
    1. Install test dependencies:
       - vitest (test runner)
       - @vitejs/plugin-react (React support)
       - @testing-library/react and @testing-library/jest-dom (React testing)
       - jsdom (browser environment)
       - msw (optional - for API mocking later)

    2. Create vitest.config.ts:
       - Use jsdom environment
       - Set up path aliases matching tsconfig (@/ -> src/)
       - Include setupTests.ts for global test setup
       - Coverage configuration (v8 provider)
       - Exclude node_modules, .next, coverage

    3. Add test scripts to package.json:
       - "test": "vitest"
       - "test:run": "vitest run"
       - "test:coverage": "vitest run --coverage"

    4. Create src/test/setup.ts:
       - Import @testing-library/jest-dom for extended matchers
       - Mock Next.js router if needed
       - Set up any global test utilities

    5. Update tsconfig.json if needed:
       - Ensure types include vitest globals
  </action>
  <verify>npm run test:run -- --passWithNoTests exits 0</verify>
  <done>Vitest configured, test command works, setup file loaded</done>
</task>

<task type="auto">
  <name>Task 2: Create OpenRouter mock client and utilities</name>
  <files>src/test/mocks/openrouter.ts, src/test/utils.ts</files>
  <action>
    1. Create src/test/mocks/openrouter.ts:
       - Export MockOpenRouterClient class implementing same interface as OpenRouterClient
       - Mock methods: chat(), chatJSON(), chatJSONValidated(), chatStream(), embeddings()
       - Allow configurable responses via constructor or method calls
       - Track call history for assertions (calls, arguments)
       - Support for simulating errors (timeout, API error, rate limit)
       - Example mock responses for common use cases

    2. Create mock response factories:
       - createMockChatResponse(content: string)
       - createMockJSONResponse<T>(data: T)
       - createMockEmbeddings(texts: string[]) - returns 1536-dim vectors
       - createMockCitations() - returns sample citation data

    3. Create src/test/utils.ts:
       - renderWithProviders() - wraps component with necessary providers
       - waitForAsync() - helper for async operations
       - createTestFormData() - generates valid OnboardingFormData
       - mockEnv() - helper to mock environment variables

    4. Export all utilities from src/test/index.ts for easy importing
  </action>
  <verify>TypeScript compiles with no errors: npx tsc --noEmit</verify>
  <done>Mock OpenRouter client created with all methods mocked, test utilities available</done>
</task>

<task type="auto">
  <name>Task 3: Create Supabase mock client</name>
  <files>src/test/mocks/supabase.ts</files>
  <action>
    1. Create src/test/mocks/supabase.ts:
       - Export createMockSupabaseClient() function
       - Mock common methods used in codebase:
         - from(table).select/insert/update/delete
         - rpc(functionName, params)
         - auth.getUser(), auth.getSession()
       - Return chainable mock objects matching Supabase query builder pattern

    2. Add mock data factories:
       - createMockUser(overrides?) - returns mock Supabase user
       - createMockSession(overrides?) - returns mock session
       - createMockBlueprint(overrides?) - returns mock blueprint row
       - createMockBlueprintChunk(overrides?) - returns mock embedding chunk

    3. Support for simulating errors:
       - mockSupabaseError(code, message)
       - Configurable per-query error injection

    4. Add to src/test/index.ts exports
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>Supabase mock client created with query builder pattern, auth mocks, and data factories</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run -- --passWithNoTests` exits with code 0
- [ ] `npx tsc --noEmit` passes (no TypeScript errors)
- [ ] Mock files exist in src/test/mocks/
- [ ] Test utilities are importable from src/test/
</verification>

<success_criteria>
- Vitest installed and configured for Next.js + React 19
- Test scripts added to package.json
- OpenRouter mock client with configurable responses
- Supabase mock client with query builder pattern
- Test utility functions available
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-test-infrastructure/19-01-SUMMARY.md`:

# Phase 19 Plan 01: Vitest Setup & Mocks Summary

**[One-liner summarizing what was built]**

## Accomplishments
- [List key outcomes]

## Files Created/Modified
- `vitest.config.ts` - Vitest configuration
- `src/test/setup.ts` - Global test setup
- `src/test/mocks/openrouter.ts` - OpenRouter mock client
- `src/test/mocks/supabase.ts` - Supabase mock client
- `src/test/utils.ts` - Test utilities
- `src/test/index.ts` - Barrel export

## Decisions Made
[Any decisions made during implementation]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 19-02-PLAN.md (Validation Tests)
</output>
