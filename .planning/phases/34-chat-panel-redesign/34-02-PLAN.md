---
phase: 34-chat-panel-redesign
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - src/components/chat/chat-sidebar.tsx
  - src/components/chat/blueprint-chat.tsx
  - src/components/chat/index.ts
  - src/app/generate/page.tsx
autonomous: true

must_haves:
  truths:
    - "Review page has permanent 30% chat sidebar on left, 70% blueprint on right"
    - "Chat includes input, messages, and suggestion pills without trigger button"
    - "Chat is hidden on complete page"
    - "Blueprint scrolls independently within right panel"
    - "Layout stacks vertically on mobile (below lg breakpoint)"
  artifacts:
    - path: "src/components/chat/chat-sidebar.tsx"
      provides: "Sidebar-formatted chat component"
      min_lines: 100
    - path: "src/app/generate/page.tsx"
      provides: "Review page with split layout"
      contains: "SplitChatLayout"
  key_links:
    - from: "src/app/generate/page.tsx"
      to: "src/components/layout/split-chat-layout.tsx"
      via: "SplitChatLayout import"
      pattern: "import.*SplitChatLayout.*from"
    - from: "src/app/generate/page.tsx"
      to: "src/components/chat/chat-sidebar.tsx"
      via: "ChatSidebar import"
      pattern: "ChatSidebar"
---

<objective>
Create ChatSidebar component and integrate the split layout into the review page, replacing the overlay chat with a permanent sidebar.

Purpose: Provide always-visible chat during blueprint review with a better side-by-side UX.
Output: Review page with 30/70 split layout (chat left, blueprint right), no floating trigger button.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-chat-panel-redesign/34-CONTEXT.md
@.planning/phases/34-chat-panel-redesign/34-RESEARCH.md
@.planning/phases/34-chat-panel-redesign/34-01-SUMMARY.md
@src/components/chat/blueprint-chat.tsx
@src/components/chat/chat-panel.tsx
@src/components/chat/quick-suggestions.tsx
@src/components/chat/message-bubble.tsx
@src/components/chat/typing-indicator.tsx
@src/app/generate/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChatSidebar component</name>
  <files>src/components/chat/chat-sidebar.tsx</files>
  <action>
    Create a new component at `src/components/chat/chat-sidebar.tsx` that extracts the chat content from BlueprintChat into a sidebar-optimized format.

    **Key differences from BlueprintChat:**
    - No floating trigger button (always visible)
    - No slide-in ChatPanel wrapper (rendered directly in sidebar)
    - Minimal header ("Chat" title only per CONTEXT.md)
    - Suggestions pills above input (per CONTEXT.md)
    - Input at bottom (standard chat UX)
    - Fits within parent container (no fixed positioning)

    **Structure:**
    ```tsx
    "use client";

    import { useState, useRef, useEffect, useCallback } from 'react';
    import { motion, AnimatePresence } from 'framer-motion';
    import { Sparkles, Send, Check, X, Loader2, Undo2, Redo2 } from 'lucide-react';
    import { MessageBubble, SourceQuality, SourceReference } from './message-bubble';
    import { TypingIndicator } from './typing-indicator';
    import { QuickSuggestions } from './quick-suggestions';
    import { MagneticButton } from '@/components/ui/magnetic-button';
    import { GradientBorder } from '@/components/ui/gradient-border';
    import { springs } from '@/lib/motion';
    import type { ChatMessageRecord, PendingEdit as DbPendingEdit, EditHistoryEntry, EditHistoryState } from '@/lib/chat/types';

    // ... Message, PendingEdit interfaces (copy from blueprint-chat.tsx)

    interface ChatSidebarProps {
      blueprint: Record<string, unknown>;
      blueprintId?: string;
      conversationId?: string;
      onBlueprintUpdate?: (updatedBlueprint: Record<string, unknown>) => void;
    }

    export function ChatSidebar({
      blueprint,
      blueprintId,
      conversationId: initialConversationId,
      onBlueprintUpdate
    }: ChatSidebarProps) {
      // Copy all the state and logic from BlueprintChat
      // EXCEPT: isOpen state, setIsOpen, trigger button rendering, ChatPanel wrapper

      // ... existing state variables (messages, input, isLoading, isStreaming, pendingEdits, etc.)
      // ... existing handlers (handleSubmit, processStream, handleConfirmAll, etc.)

      return (
        <div className="flex flex-col h-full">
          {/* Minimal header - title only */}
          <div
            className="flex-shrink-0 px-4 py-3 flex items-center justify-between"
            style={{
              borderBottom: '1px solid var(--border-subtle)',
              background: 'var(--bg-elevated)',
            }}
          >
            <div className="flex items-center gap-2">
              <Sparkles className="w-4 h-4" style={{ color: 'var(--text-tertiary)' }} />
              <span
                className="text-sm font-medium"
                style={{ color: 'var(--text-primary)' }}
              >
                Chat
              </span>
            </div>

            {/* Undo/Redo controls */}
            {(canUndo || canRedo) && (
              <div className="flex items-center gap-1">
                {/* ... undo/redo buttons (copy from blueprint-chat.tsx ChatPanel header integration) */}
              </div>
            )}
          </div>

          {/* Messages area */}
          <div className="flex-1 overflow-y-auto py-4">
            {/* Loading history state */}
            {/* Empty state with quick suggestions */}
            {/* Message list */}
            {/* Typing indicator */}
            {/* Awaiting edits indicator */}
            {/* Pending Edits Confirmation UI */}
            {/* ... copy from blueprint-chat.tsx messages area */}
          </div>

          {/* Input area with suggestions above */}
          <div
            className="flex-shrink-0 p-4"
            style={{
              borderTop: '1px solid var(--border-subtle)',
            }}
          >
            {/* Quick suggestions above input (always visible, not just empty state) */}
            {messages.length > 0 && pendingEdits.length === 0 && !isLoading && !isStreaming && (
              <div className="mb-3">
                <QuickSuggestions
                  onSelect={handleSuggestionSelect}
                  disabled={isLoading || isStreaming}
                />
              </div>
            )}

            <form onSubmit={handleSubmit} className="flex gap-2">
              {/* ... input and send button (copy from blueprint-chat.tsx) */}
            </form>
          </div>
        </div>
      );
    }
    ```

    **What to copy from BlueprintChat:**
    - All state variables (messages, input, isLoading, isStreaming, pendingEdits, editHistory, etc.)
    - All handler functions (handleSubmit, processStream, handleConfirmAll, handleCancelAll, etc.)
    - Message rendering logic (empty state, message list, typing indicator, pending edits UI)
    - applyEdits and applySingleEdit helper functions at bottom

    **What NOT to copy:**
    - isOpen state and setIsOpen
    - Floating trigger button JSX (AnimatePresence with MagneticButton at fixed bottom-6 left-6)
    - ChatPanel wrapper component

    **Changes to make:**
    - Remove ChatPanel import and wrapper
    - Move QuickSuggestions to always show above input (not just in empty state)
    - Replace ChatPanel header with minimal "Chat" header
    - Remove all references to isOpen/setIsOpen
    - Auto-load conversation on mount (remove condition checking isOpen)
  </action>
  <verify>
    1. File exists at src/components/chat/chat-sidebar.tsx
    2. TypeScript compiles: `npx tsc --noEmit`
    3. Component exports ChatSidebar function
    4. No references to isOpen, setIsOpen, ChatPanel, or floating trigger
  </verify>
  <done>
    ChatSidebar component created with:
    - Minimal header (Sparkles icon + "Chat" text)
    - Messages area with all existing functionality
    - Input at bottom with suggestions above
    - No overlay behavior, fits within parent container
  </done>
</task>

<task type="auto">
  <name>Task 2: Update chat barrel exports</name>
  <files>src/components/chat/index.ts</files>
  <action>
    Add ChatSidebar to the barrel exports in `src/components/chat/index.ts`:

    ```ts
    export { BlueprintChat } from './blueprint-chat';
    export { ChatSidebar } from './chat-sidebar';
    export { ChatMessage } from './chat-message';
    export { ChatPanel } from './chat-panel';
    export { MessageBubble } from './message-bubble';
    export { TypingIndicator } from './typing-indicator';
    export { QuickSuggestions } from './quick-suggestions';
    ```

    Keep BlueprintChat export for backwards compatibility (may still be used elsewhere).
    Keep ChatPanel export in case it's needed for other use cases.
  </action>
  <verify>
    File exports ChatSidebar along with existing exports.
  </verify>
  <done>ChatSidebar added to chat component exports</done>
</task>

<task type="auto">
  <name>Task 3: Integrate SplitChatLayout into review page</name>
  <files>src/app/generate/page.tsx</files>
  <action>
    Update the review-blueprint state rendering in `src/app/generate/page.tsx` to use SplitChatLayout with ChatSidebar.

    **Import changes:**
    ```tsx
    import { SplitChatLayout } from '@/components/layout';
    import { ChatSidebar } from '@/components/chat';
    // Keep BlueprintChat import for now (will be removed if not used elsewhere)
    ```

    **Review page layout changes:**

    Find the `review-blueprint` state rendering (around line 826):
    ```tsx
    // Review Blueprint State
    if (pageState === "review-blueprint" && strategicBlueprint) {
    ```

    Replace the entire return block with:

    ```tsx
    // Review Blueprint State
    if (pageState === "review-blueprint" && strategicBlueprint) {
      return (
        <div className="h-screen" style={{ background: 'var(--bg-base)' }}>
          <SplitChatLayout
            chatContent={
              <ChatSidebar
                blueprint={strategicBlueprint as unknown as Record<string, unknown>}
                onBlueprintUpdate={(updated) => setStrategicBlueprint(updated as unknown as StrategicBlueprintOutput)}
              />
            }
            blueprintContent={
              <div className="container mx-auto px-4 py-8 md:py-12">
                {/* Stage Indicator */}
                <motion.div
                  className="mx-auto max-w-5xl mb-8"
                  initial={{ opacity: 0, y: -10 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ duration: 0.5 }}
                >
                  {/* ... existing stage indicator JSX ... */}
                </motion.div>

                {/* Review Component */}
                <div className="mx-auto max-w-6xl">
                  <BlueprintDocument
                    strategicBlueprint={strategicBlueprint}
                    onApprove={handleApprove}
                    onRegenerate={handleRegenerateBlueprint}
                  />
                </div>
              </div>
            }
          />
        </div>
      );
    }
    ```

    **Key changes:**
    1. Wrap everything in SplitChatLayout (replaces plain div)
    2. Pass ChatSidebar as chatContent prop
    3. Pass blueprint content (stage indicator + BlueprintDocument) as blueprintContent prop
    4. Change outer container from `min-h-screen` to `h-screen` (required for split layout to work)
    5. Remove the standalone BlueprintChat component at the bottom (it's now integrated via ChatSidebar)

    **Complete page (no changes needed):**
    The complete page state should NOT have any chat. Verify the complete page rendering does not include BlueprintChat or ChatSidebar. It should remain as-is showing PolishedBlueprintView with header buttons.
  </action>
  <verify>
    1. `npm run build` passes
    2. Review page imports SplitChatLayout and ChatSidebar
    3. Review page uses SplitChatLayout wrapper
    4. Complete page has NO chat components
    5. No duplicate BlueprintChat rendering (removed from review page)
  </verify>
  <done>
    Review page updated with:
    - SplitChatLayout wrapping chat + blueprint content
    - ChatSidebar in left panel (30% default width)
    - Blueprint content in right panel (70%)
    - No floating trigger button on review page
    - Complete page unchanged (no chat)
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. Manual testing in browser:
   - Review page: Chat sidebar visible on left, blueprint on right
   - Resize handle visible between panels
   - Can drag to resize (20% to 40% range)
   - Mobile (< 1024px): Chat below blueprint in vertical stack
   - Complete page: No chat visible
3. Chat functionality preserved:
   - Can send messages
   - Streaming responses work
   - Edit proposals with confirm/cancel work
   - Undo/redo works
</verification>

<success_criteria>
1. Review page has permanent 30% chat sidebar on left, 70% blueprint on right
2. Chat includes input, messages, suggestions without trigger button
3. Layout stacks vertically on mobile (below lg breakpoint)
4. Chat completely hidden on complete page
5. Blueprint scrolls independently within right panel
6. All existing chat functionality preserved (streaming, edits, undo/redo)
</success_criteria>

<output>
After completion, create `.planning/phases/34-chat-panel-redesign/34-02-SUMMARY.md`
</output>
