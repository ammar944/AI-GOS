---
phase: 04-error-reporting
plan: 02
type: execute
---

<objective>
Add React error boundary and enhanced error UI that surfaces specific failure reasons and enables retry from failed section.

Purpose: Give users clear feedback on what went wrong and actionable recovery options.
Output: Global error boundary component, enhanced error display with codes, retry-from-section capability.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-error-reporting/04-01-SUMMARY.md

**Prior plan dependencies:**
- 04-01 created structured error responses with ErrorCode and retryable flag

**Relevant source files:**
@src/app/generate/page.tsx
@src/components/media-plan/form-wizard.tsx
@src/components/media-plan/progress-indicator.tsx
@src/lib/errors.ts (created in 04-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create global React error boundary component</name>
  <files>src/components/error-boundary.tsx, src/app/layout.tsx</files>
  <action>
1. Create ErrorBoundary class component in src/components/error-boundary.tsx:
   - Use React.Component with state `{ hasError: boolean, error?: Error }`
   - Implement static getDerivedStateFromError(error) → return { hasError: true, error }
   - Implement componentDidCatch(error, errorInfo) → log to console.error with component stack
   - Render fallback UI when hasError:
     - Card with destructive border
     - XCircle icon
     - "Something went wrong" heading
     - error.message in code block
     - "Reload Page" button that calls window.location.reload()
     - "Go Home" link to "/"
   - Accept children prop, render children when no error

2. Update src/app/layout.tsx:
   - Import ErrorBoundary
   - Wrap {children} in <ErrorBoundary> inside body

Keep styling consistent with existing error UI in generate/page.tsx (use destructive colors, XCircle icon).
  </action>
  <verify>npm run build succeeds, app loads without error</verify>
  <done>ErrorBoundary catches unhandled React errors and shows recovery UI</done>
</task>

<task type="auto">
  <name>Task 2: Create error display component with structured error support</name>
  <files>src/components/ui/api-error-display.tsx</files>
  <action>
Create a reusable API error display component:

1. Define props interface:
   ```typescript
   interface ApiErrorDisplayProps {
     error: {
       code?: string;
       message: string;
       details?: string;
       retryable?: boolean;
       section?: string;
       completedSections?: string[];
     } | string;
     onRetry?: () => void;
     onRetryFromSection?: (section: string) => void;
     onGoBack?: () => void;
   }
   ```

2. Component renders:
   - Card with destructive/20 border
   - XCircle icon in red
   - Error code badge if present (e.g., "TIMEOUT", "RATE_LIMITED")
   - Human-readable message based on code:
     - TIMEOUT → "The request took too long. Try again."
     - RATE_LIMITED → "Service is busy. Please wait a moment and retry."
     - CIRCUIT_OPEN → "Service temporarily unavailable. Retry in a minute."
     - VALIDATION_FAILED → "AI response was malformed. Retrying may help."
     - PARSE_ERROR → "Failed to parse AI response. Try again."
     - API_ERROR → "External service error. Please retry."
     - INTERNAL_ERROR → "An unexpected error occurred."
     - Default → error.message
   - Details in muted text if provided
   - Section badge if failed at specific section ("Failed at: {section}")
   - Completed sections as success badges if partial result
   - Action buttons:
     - "Retry" button if retryable && onRetry provided
     - "Retry from {section}" button if section && onRetryFromSection provided
     - "Go Back" outline button if onGoBack provided

3. Export helper `parseApiError(response)` that:
   - Takes API response object
   - Extracts error object (handles both string and structured)
   - Returns typed error object for the component
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>Reusable error display component exists with code-aware messaging</done>
</task>

<task type="auto">
  <name>Task 3: Integrate enhanced error UI into generate page</name>
  <files>src/app/generate/page.tsx</files>
  <action>
Update the generate page to use the new error display:

1. Import `ApiErrorDisplay`, `parseApiError` from `@/components/ui/api-error-display`

2. Update error state to store structured error:
   - Change `error: string | null` to `error: ReturnType<typeof parseApiError> | null`

3. Update handleOnboardingComplete catch block:
   - Parse result.error with parseApiError if result exists
   - Otherwise create basic error from err.message

4. Replace error state rendering (pageState === "error"):
   - Use <ApiErrorDisplay> instead of inline error display
   - Pass error object
   - Pass onRetry={handleRetryBlueprint}
   - Pass onGoBack={handleStartOver}
   - Remove the existing inline error card

5. If partial result returned (result.partialPlan or result.completedSections):
   - Store partial data
   - Show partial result with error state (completed sections + error display)
   - Enable "Retry from failed section" if applicable

Keep existing flow logic, just enhance error display.
  </action>
  <verify>npm run build succeeds</verify>
  <done>Generate page shows structured error messages with code badges and appropriate retry options</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] ErrorBoundary wraps app and catches React errors
- [ ] ApiErrorDisplay shows code badges and human-readable messages
- [ ] Generate page uses new error display with retry buttons
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Users see clear error messages with specific failure reasons
- Retry buttons are visible and functional
- Error boundary catches React crashes
</success_criteria>

<output>
After completion, create `.planning/phases/04-error-reporting/04-02-SUMMARY.md`

Phase 4 completion note:
After 04-02 completes, Phase 4: Error Reporting and Recovery is DONE.
Update STATE.md to reflect Milestone 1: Stabilization complete.
</output>
