---
phase: 11-section4-enhancement
plan: 01
type: execute
---

<objective>
Enhance Section 4 (Competitor Analysis) with real-time research using Perplexity Deep Research.

Purpose: Replace static AI-generated competitor data with real-time web search results and citations.
Output: CompetitorAnalysis section now uses ResearchAgent, returns CitedSectionOutput with verifiable sources.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior decisions affecting this phase:**
- Phase 10: ResearchAgent wraps OpenRouterClient with citation extraction and cost tracking
- Phase 10: Empty citations returned for chatJSONValidated calls (use research() for citation-critical)
- Phase 9: PERPLEXITY_DEEP_RESEARCH model available with hasWebSearch() helper

**Infrastructure from Phase 10:**
@src/lib/research/agent.ts
@src/lib/research/types.ts
@src/lib/research/index.ts

**Current Section 4 implementation:**
@src/lib/strategic-blueprint/pipeline/strategic-blueprint-generator.ts
@src/lib/strategic-blueprint/output-types.ts

**OpenRouter client with models:**
@src/lib/openrouter/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create competitor research function</name>
  <files>src/lib/strategic-blueprint/pipeline/competitor-research.ts</files>
  <action>
Create a dedicated competitor research function that uses ResearchAgent with Perplexity Deep Research:

1. Create `src/lib/strategic-blueprint/pipeline/competitor-research.ts`
2. Export `researchCompetitors(context: string): Promise<CitedSectionOutput<CompetitorAnalysis>>`
3. Use `createResearchAgent()` from `@/lib/research`
4. Use `MODELS.PERPLEXITY_DEEP_RESEARCH` for real-time competitor web search
5. Use `agent.research()` (NOT researchJSON) to preserve citations
6. Parse JSON response manually with try/catch and regex extraction
7. Return CitedSectionOutput with:
   - data: CompetitorAnalysis (validated)
   - citations: Citation[] from research response
   - model: string
   - cost: number

The prompt should instruct Perplexity to:
- Search for real competitor information using the provided context
- Include actual company names, pricing, and ad platforms from web results
- Return JSON matching CompetitorAnalysis schema

Important: Use research() not researchJSON() because we need citations preserved.
  </action>
  <verify>File exists, TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>competitor-research.ts exports researchCompetitors function that returns CitedSectionOutput<CompetitorAnalysis></done>
</task>

<task type="auto">
  <name>Task 2: Update strategic blueprint generator for Section 4</name>
  <files>src/lib/strategic-blueprint/pipeline/strategic-blueprint-generator.ts</files>
  <action>
Modify the strategic blueprint generator to use the new competitor research for Section 4:

1. Import `researchCompetitors` from `./competitor-research`
2. Import `CitedSectionOutput` from `../output-types`
3. In the main loop, add special handling for `competitorAnalysis` section:
   - Instead of using `client.chatJSON()` with CLAUDE_SONNET
   - Call `researchCompetitors(context)`
   - Store result.data in partialOutput.competitorAnalysis
   - Track citations separately (new field or accumulator)
   - Add result.cost to totalCost
4. Keep other sections using existing Claude Sonnet approach
5. Update metadata.modelsUsed to include PERPLEXITY_DEEP_RESEARCH when used

Pattern:
```typescript
if (section === 'competitorAnalysis') {
  const result = await researchCompetitors(context);
  partialOutput[section] = result.data;
  // Store citations for later (Phase 14 will display them)
  totalCost += result.cost;
  sectionTimings[section] = Date.now() - sectionStart;
  completedSections.push(section);
  continue;
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>competitorAnalysis section uses Perplexity Deep Research via researchCompetitors()</done>
</task>

<task type="auto">
  <name>Task 3: Add section citations tracking to generator</name>
  <files>src/lib/strategic-blueprint/pipeline/strategic-blueprint-generator.ts, src/lib/strategic-blueprint/output-types.ts</files>
  <action>
Add infrastructure to track citations per section for later display (Phase 14):

1. In output-types.ts, add to StrategicBlueprintMetadata:
   ```typescript
   /** Citations collected during research (keyed by section) */
   sectionCitations?: Record<string, Citation[]>;
   ```

2. In strategic-blueprint-generator.ts:
   - Add `sectionCitations: Record<string, Citation[]> = {}` accumulator
   - When researchCompetitors returns, store: `sectionCitations.competitorAnalysis = result.citations`
   - Include sectionCitations in final metadata
   - Update modelsUsed array to include MODELS.PERPLEXITY_DEEP_RESEARCH

3. Ensure backwards compatibility - sectionCitations is optional, existing code won't break
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`, build succeeds: `npm run build`</verify>
  <done>StrategicBlueprintOutput.metadata includes sectionCitations with competitorAnalysis citations</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] `npm run build` succeeds
- [ ] competitor-research.ts exports researchCompetitors function
- [ ] strategic-blueprint-generator.ts uses Perplexity for Section 4
- [ ] StrategicBlueprintMetadata includes sectionCitations field
- [ ] metadata.modelsUsed includes PERPLEXITY_DEEP_RESEARCH after generation
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Section 4 (competitorAnalysis) uses real-time Perplexity research
- Citations are extracted and stored in metadata.sectionCitations
- Other sections (1, 2, 3, 5) continue using Claude Sonnet unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/11-section4-enhancement/11-01-SUMMARY.md`:

# Phase 11 Plan 1: Section 4 Competitor Analysis Enhancement Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 11 complete, ready for Phase 12 (Section 1 Industry Market Enhancement)
</output>
